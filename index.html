<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MORSE-LINK LIVE | Radio in Vetta</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --amber: #ffb000; 
            --bg-black: #0a0a0a; 
            --panel: #1e1e1e; 
            --green: #0f0;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body { 
            background: var(--bg-black); 
            color: var(--amber); 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            overflow: hidden;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        #login-overlay { 
            position: fixed; 
            inset: 0; 
            background: var(--bg-black); 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            gap: 15px;
        }
        
        #login-overlay h2 {
            color: var(--amber);
            text-shadow: 0 0 10px var(--amber);
            margin: 0;
        }
        
        .online-badge {
            background: #0a3d0a;
            color: var(--green);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 1px solid var(--green);
        }
        
        header { 
            background: var(--panel); 
            padding: 8px; 
            border-bottom: 2px solid var(--amber); 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }
        
        body.has-background header {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .admin-btn {
            background: #222;
            color: #888;
            border: 1px solid #444;
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .admin-btn:hover {
            background: #333;
            color: var(--amber);
            border-color: var(--amber);
        }
        
        #main { 
            display: grid; 
            grid-template-columns: 200px 1fr; 
            flex: 1; 
            overflow: hidden;
            position: relative;
            min-height: 0;
        }
        
        #main::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(10, 10, 10, 0.7);
            z-index: 0;
            pointer-events: none;
            display: none;
        }
        
        body.has-background #main::before {
            display: block;
        }
        
        #sidebar, #chat {
            position: relative;
            z-index: 1;
        }
        
        #sidebar { 
            border-right: 1px solid #333; 
            padding: 10px; 
            overflow-y: auto;
            background: var(--panel);
        }
        
        #chat { 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }
        
        #messages { 
            flex: 1; 
            background: rgba(0, 0, 0, 0.7); 
            border: 1px solid #333; 
            padding: 10px; 
            overflow-y: auto; 
            overflow-x: hidden;
            margin-bottom: 10px; 
            font-size: 1.2rem;
            line-height: 1.5;
            -webkit-overflow-scrolling: touch;
            transition: background-color 0.3s ease;
            min-height: 0;
        }
        
        #messages.hide-text .msg {
            display: none;
        }
        
        #messages.hide-text::after {
            content: 'üîá MODALIT√Ä SOLO AUDIO';
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #666;
            font-size: 1rem;
        }
        
        body.has-background #messages {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        #decoder-preview { 
            height: 25px; 
            font-size: 1.3rem; 
            text-align: center;
            color: var(--green);
            font-weight: bold;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        
        #morse-pad { 
            height: 140px; 
            background: var(--panel); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            border-radius: 10px; 
            position: relative;
            border: 1px solid #333;
            flex-shrink: 0;
        }
        
        #key { 
            width: 100px; 
            height: 100px; 
            border: 4px solid var(--amber); 
            border-radius: 50%; 
            cursor: pointer; 
            touch-action: none;
            transition: background 0.05s, transform 0.1s;
            user-select: none;
        }
        
        #key:active { 
            background: var(--amber); 
            box-shadow: 0 0 20px var(--amber);
            transform: scale(0.95);
        }
        
        .user-tag { 
            display: block; 
            padding: 5px; 
            color: var(--green); 
            border-bottom: 1px solid #222;
            font-size: 0.9rem;
        }
        
        .msg { 
            margin-bottom: 10px; 
            border-left: 2px solid var(--amber); 
            padding-left: 8px;
            word-wrap: break-word;
        }
        
        .input-box { 
            background: #000; 
            border: 1px solid var(--amber); 
            color: var(--amber); 
            padding: 10px; 
            margin: 5px;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
        }
        
        button {
            background: var(--panel);
            color: var(--amber);
            border: 2px solid var(--amber);
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        button:hover {
            background: var(--amber);
            color: #000;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        .clear-btn {
            border-color: #f00;
            color: #f00;
            font-size: 0.85rem;
            padding: 5px 10px;
        }
        
        .clear-btn:hover {
            background: #f00;
            color: #000;
        }
        
        .toggle-text-btn {
            border-color: var(--green);
            color: var(--green);
            font-size: 0.85rem;
            padding: 5px 10px;
            margin-bottom: 5px;
        }
        
        .toggle-text-btn:hover {
            background: var(--green);
            color: #000;
        }
        
        .toggle-text-btn.active {
            background: var(--green);
            color: #000;
        }
        
        #admin-modal, #admin-panel {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #admin-modal.show, #admin-panel.show {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px 0;
        }
        
        .modal-content {
            background: var(--panel);
            border: 2px solid var(--amber);
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
        }
        
        .panel-content {
            background: var(--panel);
            border: 2px solid var(--amber);
            padding: 20px;
            border-radius: 10px;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .stat-box {
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .stat-label {
            color: #888;
            font-size: 0.9rem;
        }
        
        .stat-value {
            color: var(--amber);
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .upload-zone {
            border: 2px dashed #666;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-zone:hover {
            border-color: var(--amber);
            background: rgba(255, 176, 0, 0.1);
        }
        
        .bg-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border: 2px solid var(--amber);
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .close-btn {
            float: right;
            background: #f00;
            border-color: #f00;
            color: #fff;
            padding: 5px 15px;
        }
        
        .close-btn:hover {
            background: #c00;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #333;
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--amber);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #ffcc00;
            transform: scale(1.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--amber);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        input[type="range"]::-moz-range-thumb:hover {
            background: #ffcc00;
            transform: scale(1.2);
        }
        
        @keyframes flash {
            0% { border-color: #333; }
            50% { border-color: var(--green); }
            100% { border-color: #333; }
        }
        
        #messages.new-message {
            animation: flash 0.5s ease;
        }
        
        @media (max-width: 768px) {
            #main { 
                grid-template-columns: 1fr; 
                grid-template-rows: auto 1fr;
            }
            
            #sidebar { 
                border-right: none;
                border-bottom: 1px solid #333;
                max-height: 80px;
                overflow-y: auto;
            }
            
            #messages {
                font-size: 1rem;
                flex: 1;
                min-height: 120px;
            }
            
            #decoder-preview {
                height: 20px;
                font-size: 1.1rem;
            }
            
            #morse-pad {
                height: 120px;
            }
            
            #key {
                width: 80px;
                height: 80px;
            }
            
            header {
                padding: 5px;
                font-size: 0.9rem;
            }
            
            button {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-height: 600px) {
            #morse-pad {
                height: 100px;
            }
            
            #key {
                width: 70px;
                height: 70px;
            }
            
            #messages {
                min-height: 80px;
            }
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <h2>üì° MORSE-LINK LIVE</h2>
    <div class="online-badge">üåç RADIO IN VETTA</div>
    <p style="color: #888; margin: 0; font-size: 0.9rem;">Real-time Global CW Chat by IU2RPQ</p>
    <input type="text" id="callsign" class="input-box" placeholder="TUO NOMINATIVO (es. IU2RPQ)" maxlength="10">
    <button onclick="startApp()">‚ñ∂ CONNETTI</button>
</div>

<header>
    <div><strong>STAZIONE:</strong> <span id="my-id">---</span></div>
    <div id="status-indicator" style="color: var(--green);">‚óè ONLINE</div>
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button onclick="mapExternalKey()" id="map-btn" style="padding: 5px 10px; font-size: 0.85rem;">MAPPA TASTO</button>
        <button class="admin-btn" onclick="showAdminLogin()">üîê ADMIN</button>
    </div>
</header>

<div id="main">
    <div id="sidebar">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 5px;">
            <strong style="font-size: 0.9rem;">üåç ONLINE</strong>
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                <button class="toggle-text-btn" onclick="toggleTextDisplay()" id="toggle-text-btn" title="Mostra/Nascondi testo">üëÅÔ∏è</button>
                <button class="clear-btn" onclick="clearChat()" title="Pulisci chat">üóëÔ∏è</button>
            </div>
        </div>
        <div id="user-list"></div>
        <button id="audio-activate-btn" onclick="activateAudioManually()" style="width: 100%; margin-top: 10px; display: none; background: var(--green); border-color: var(--green); color: #000; font-size: 0.85rem; padding: 8px;">
            üîä ATTIVA AUDIO
        </button>
    </div>
    <div id="chat">
        <div id="messages"></div>
        <div id="decoder-preview"></div>
        <div id="morse-pad">
            <div id="key"></div>
        </div>
    </div>
</div>

<div id="admin-modal">
    <div class="modal-content">
        <h2 style="color: var(--amber); margin-top: 0;">üîê ACCESSO ADMIN</h2>
        <input type="password" id="admin-pwd" class="input-box" placeholder="Password" style="margin: 20px 0;">
        <div style="display: flex; gap: 10px;">
            <button onclick="checkAdminPassword()" style="flex: 1;">ACCEDI</button>
            <button onclick="closeAdminModal()" style="flex: 1; background: #333;">ANNULLA</button>
        </div>
        <p id="admin-error" style="color: #f00; margin-top: 10px; display: none;">Password errata!</p>
    </div>
</div>

<div id="admin-panel">
    <div class="panel-content">
        <button class="close-btn" onclick="closeAdminPanel()">‚úï CHIUDI</button>
        <h2 style="color: var(--amber);">‚öôÔ∏è PANNELLO AMMINISTRAZIONE</h2>
        
        <h3 style="color: var(--green); margin-top: 30px;">üñºÔ∏è SFONDO PERSONALIZZATO</h3>
        <div class="upload-zone" onclick="document.getElementById('bg-upload').click()">
            <p>üìÅ Clicca per caricare immagine di sfondo</p>
            <p style="color: #666; font-size: 0.8rem;">JPG, PNG (max 5MB) - Ottimizzazione automatica</p>
        </div>
        <input type="file" id="bg-upload" accept="image/*" style="display: none;" onchange="handleBackgroundUpload(event)">
        
        <div id="bg-preview-container" style="display: none;">
            <img id="bg-preview" class="bg-preview">
            <button onclick="removeBackground()" style="background: #f00; border-color: #f00;">üóëÔ∏è RIMUOVI SFONDO</button>
        </div>
        
        <h3 style="color: var(--green); margin-top: 30px;">üé® TRASPARENZA CHAT</h3>
        <p style="color: #888; font-size: 0.9rem;">Regola l'opacit√† della finestra messaggi per vedere lo sfondo</p>
        
        <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 10px;">
                Opacit√†: <span id="opacity-value">70</span>%
            </label>
            <input 
                type="range" 
                id="opacity-slider" 
                min="0" 
                max="100" 
                value="70" 
                style="width: 100%; cursor: pointer;"
                oninput="updateChatOpacity(this.value)">
            <div style="display: flex; justify-content: space-between; color: #666; font-size: 0.8rem; margin-top: 5px;">
                <span>Trasparente</span>
                <span>Opaco</span>
            </div>
        </div>
        
        <button onclick="resetOpacity()" style="width: 100%; margin-top: 10px;">
            üîÑ RESET OPACIT√Ä (70%)
        </button>
        
        <h3 style="color: var(--green); margin-top: 30px;">üîä TEST AUDIO</h3>
        <p style="color: #888; font-size: 0.9rem;">Verifica che l'audio in ricezione funzioni</p>
        
        <button onclick="testAudioReception()" style="width: 100%; margin-top: 10px;">
            üéµ TEST AUDIO RICEZIONE (SOS)
        </button>
        <p id="audio-test-result" style="color: #666; font-size: 0.8rem; margin-top: 10px;"></p>
        
        <h3 style="color: var(--green); margin-top: 30px;">üìä STATISTICHE TRAFFICO</h3>
        
        <div class="stat-box">
            <div class="stat-label">Messaggi Totali</div>
            <div class="stat-value" id="stat-messages">0</div>
        </div>
        
        <div class="stat-box">
            <div class="stat-label">Caratteri Trasmessi</div>
            <div class="stat-value" id="stat-chars">0</div>
        </div>
        
        <div class="stat-box">
            <div class="stat-label">Utenti Unici (Globali)</div>
            <div class="stat-value" id="stat-users">0</div>
        </div>
        
        <div class="stat-box">
            <div class="stat-label">Utenti Online Ora</div>
            <div class="stat-value" id="stat-online">0</div>
        </div>
        
        <div class="stat-box">
            <div class="stat-label">Sessioni Totali</div>
            <div class="stat-value" id="stat-sessions">0</div>
        </div>
        
        <div class="stat-box">
            <div class="stat-label">Ultimo Messaggio</div>
            <div class="stat-value" id="stat-last" style="font-size: 1.2rem;">---</div>
        </div>
        
        <button onclick="resetStats()" style="background: #f00; border-color: #f00; margin-top: 20px; width: 100%;">
            üóëÔ∏è RESET STATISTICHE
        </button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA7XqQnQRc0NbxgewBADmpdieylU7eTNHE",
        authDomain: "morse-link-live.firebaseapp.com",
        databaseURL: "https://morse-link-live-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "morse-link-live",
        storageBucket: "morse-link-live.firebasestorage.app",
        messagingSenderId: "170315866392",
        appId: "1:170315866392:web:91918cc223656b2d40be6d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let callsign = "";
    let audioCtx, oscillator, gainNode;
    let startTime = 0, isDown = false, morseBuffer = "";
    let mappedKey = null, isMapping = false;
    let lastUp = Date.now();
    let sessionStartTime = null;
    let textDisplayEnabled = true;
    let audioEnabled = false;
    
    const ADMIN_PASSWORD = "radio1010";
    const lastMsgUser = {};
    const DOT_DURATION = 100;
    const DASH_DURATION = 300;
    const SYMBOL_GAP = 100;
    const LETTER_GAP = 300;

    const MORSE = { 
        ".-": "A", "-...": "B", "-.-.": "C", "-..": "D", ".": "E", 
        "..-.": "F", "--.": "G", "....": "H", "..": "I", ".---": "J", 
        "-.-": "K", ".-..": "L", "--": "M", "-.": "N", "---": "O", 
        ".--.": "P", "--.-": "Q", ".-.": "R", "...": "S", "-": "T", 
        "..-": "U", "...-": "V", ".--": "W", "-..-": "X", "-.--": "Y", 
        "--..": "Z", "-----": "0", ".----": "1", "..---": "2", "...--": "3", 
        "....-": "4", ".....": "5", "-....": "6", "--...": "7", "---..": "8", 
        "----.": "9", "..--..": "?", "-..-.": "/", ".-.-.-": "."
    };

    const CHAR_TO_MORSE = Object.fromEntries(Object.entries(MORSE).map(([k, v]) => [v, k]));

    function scrollToBottom() {
        const box = document.getElementById('messages');
        requestAnimationFrame(() => {
            box.scrollTop = box.scrollHeight;
        });
    }

    function initAudioContext() {
        if(!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            console.log('üéµ Audio context creato:', audioCtx.state);
        }
        if(audioCtx.state === 'suspended') {
            audioCtx.resume().then(() => {
                console.log('üéµ Audio context attivo:', audioCtx.state);
            });
        }
        return audioCtx;
    }
    
    function ensureAudioReady() {
        if(!audioCtx) {
            initAudioContext();
        }
        if(audioCtx && audioCtx.state === 'suspended') {
            return audioCtx.resume();
        }
        return Promise.resolve();
    }

    function playMorseChar(char) {
        if(!audioCtx) {
            console.warn('‚ö†Ô∏è Audio context non inizializzato');
            return;
        }
        
        if(audioCtx.state === 'suspended') {
            console.log('‚è∏Ô∏è Audio context sospeso, riattivo...');
            audioCtx.resume();
        }
        
        const morse = CHAR_TO_MORSE[char.toUpperCase()];
        if(!morse) {
            console.log('‚ö†Ô∏è Carattere non mappato:', char);
            return;
        }
        
        console.log('üîä Riproduco Morse:', char, '‚Üí', morse);
        
        const symbols = morse.split('');
        let currentTime = 0;
        
        symbols.forEach((symbol, index) => {
            setTimeout(() => {
                playMorseSymbol(symbol);
            }, currentTime);
            
            const duration = (symbol === '.') ? DOT_DURATION : DASH_DURATION;
            currentTime += duration + SYMBOL_GAP;
        });
    }
    
    function playMorseSymbol(symbol) {
        if(!audioCtx) return;
        
        try {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'sine';
            osc.frequency.value = 700;
            gain.gain.value = 0.2;
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            const duration = (symbol === '.') ? DOT_DURATION : DASH_DURATION;
            const now = audioCtx.currentTime;
            
            osc.start(now);
            osc.stop(now + (duration / 1000));
            
            console.log('üéµ', symbol === '.' ? 'BIP' : 'BIIIIP');
        } catch(err) {
            console.error('‚ùå Errore riproduzione:', err);
        }
    }

    function sendMessage(char) {
        db.ref('chat').push({
            user: callsign,
            text: char,
            time: Date.now()
        });
        
        db.ref('admin/stats/totalChars').transaction((current) => (current || 0) + char.length);
    }

    async function addMsgToUI(user, text, shouldPlayAudio = false) {
        const box = document.getElementById('messages');
        const last = box.lastElementChild;
        
        if(last && last.dataset.user === user) {
            const strong = last.querySelector('strong');
            const currentContent = last.textContent || last.innerText;
            const contentAfterName = currentContent.substring(currentContent.indexOf(':') + 1).trim();
            
            last.innerHTML = '';
            last.appendChild(strong);
            last.appendChild(document.createTextNode(' ' + contentAfterName + text));
        } else {
            const div = document.createElement('div');
            div.className = 'msg';
            div.dataset.user = user;
            const userColor = user === callsign ? 'var(--amber)' : '#0af';
            
            const strong = document.createElement('strong');
            strong.style.color = userColor;
            strong.textContent = user + ':';
            
            div.appendChild(strong);
            div.appendChild(document.createTextNode(' ' + text));
            box.appendChild(div);
        }
        
        scrollToBottom();
        
        if(shouldPlayAudio && audioEnabled) {
            console.log('üéµ Audio richiesto per:', text, 'da', user);
            await playMorseChar(text);
        }
    }

    function toggleTextDisplay() {
        textDisplayEnabled = !textDisplayEnabled;
        const box = document.getElementById('messages');
        const btn = document.getElementById('toggle-text-btn');
        
        if(textDisplayEnabled) {
            box.classList.remove('hide-text');
            btn.classList.remove('active');
            btn.innerText = 'üëÅÔ∏è';
        } else {
            box.classList.add('hide-text');
            btn.classList.add('active');
            btn.innerText = 'üîá';
        }
        
        console.log(`üì∫ Visualizzazione testo: ${textDisplayEnabled ? 'ON' : 'OFF'}`);
    }

    function clearChat() {
        if(confirm('Pulire la visualizzazione della chat?\n(I messaggi restano nel database)')) {
            document.getElementById('messages').innerHTML = '';
        }
    }

    function startApp() {
        callsign = document.getElementById('callsign').value.trim().toUpperCase();
        
        if(!callsign) {
            alert('Inserisci il tuo nominativo!');
            return;
        }
        
        if(callsign.length < 3) {
            alert('Nominativo troppo corto (min 3 caratteri)!');
            return;
        }
        
        document.getElementById('my-id').innerText = callsign;
        document.getElementById('login-overlay').style.display = 'none';
        
        initAudio();
        
        const activateBtn = document.getElementById('audio-activate-btn');
        if(activateBtn) {
            activateBtn.style.display = 'block';
        }

        const userRef = db.ref('users/' + callsign);
        userRef.set({ 
            status: "online", 
            lastSeen: Date.now() 
        });
        userRef.onDisconnect().remove();

        db.ref('users').on('value', snap => {
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            let count = 0;
            snap.forEach(child => {
                const isSelf = child.key === callsign;
                const color = isSelf ? 'var(--amber)' : 'var(--green)';
                const suffix = isSelf ? ' (TU)' : '';
                list.innerHTML += `<span class="user-tag" style="color: ${color};">‚Ä¢ ${child.key}${suffix}</span>`;
                count++;
            });
            if(count === 0) {
                list.innerHTML = '<span style="color: #666;">Nessuno online</span>';
            }
        });

        let initialLoad = true;
        db.ref('chat').limitToLast(50).once('value', () => {
            initialLoad = false;
            console.log('‚úÖ Caricamento iniziale completato');
        });
        
        db.ref('chat').limitToLast(50).on('child_added', snap => {
            const data = snap.val();
            if(data && data.user && data.text) {
                const isNewMessage = !lastMsgUser[data.user] || lastMsgUser[data.user] !== snap.key;
                if(isNewMessage) {
                    const isRemote = data.user !== callsign;
                    const shouldPlayAudio = !initialLoad && isRemote;
                    
                    addMsgToUI(data.user, data.text, shouldPlayAudio);
                    lastMsgUser[data.user] = snap.key;
                    
                    if(shouldPlayAudio) {
                        console.log('üîä Nuovo messaggio remoto da:', data.user);
                    }
                }
            }
        });

        db.ref('admin/background').once('value').then(snap => {
            const bgData = snap.val();
            if(bgData) {
                applyBackground(bgData);
            }
        });
        
        db.ref('admin/chatOpacity').once('value').then(snap => {
            const opacity = snap.val();
            if(opacity !== null && opacity !== undefined) {
                applyChatOpacity(opacity);
            }
        });

        trackSession();
        
        console.log('‚úÖ Connesso come:', callsign);
        console.log('üéµ Audio stato:', audioCtx ? audioCtx.state : 'non inizializzato');
    }
    
    function playTestBeep() {
        if(!audioCtx) return;
        
        try {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.frequency.value = 700;
            gain.gain.value = 0.1;
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
            
            console.log('üîî Beep test - Audio attivo!');
            
            const btn = document.getElementById('audio-activate-btn');
            if(btn) {
                btn.style.display = 'none';
            }
        } catch(e) {
            console.error('‚ùå Test beep fallito:', e);
        }
    }
    
    function activateAudioManually() {
        if(audioCtx) {
            if(audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    console.log('‚úÖ Audio attivato manualmente!');
                    playTestBeep();
                    alert('‚úÖ Audio attivato! Ora puoi sentire i messaggi in arrivo.');
                });
            } else {
                playTestBeep();
                alert('‚úÖ Audio gi√† attivo!');
            }
        }
    }

    function play() {
        if(!audioCtx) {
            initAudio();
        }
        
        if(audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        
        oscillator = audioCtx.createOscillator();
        gainNode = audioCtx.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.value = 700;
        gainNode.gain.value = 0.15;
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
    }

    function stop() { 
        if(oscillator) {
            oscillator.stop(); 
            oscillator = null;
        }
    }

    function down(e) {
        if(isMapping) {
            mappedKey = (e.type === 'keydown') ? e.code : 'MOUSE';
            isMapping = false;
            document.getElementById('map-btn').innerText = "TASTO: " + mappedKey;
            return;
        }
        
        if(mappedKey && e.type === 'keydown' && e.code !== mappedKey) return;
        
        if(isDown) return;
        
        isDown = true;
        startTime = Date.now();
        play();
    }

    function up() {
        if(!isDown) return;
        
        isDown = false;
        stop();
        
        const dur = Date.now() - startTime;
        morseBuffer += (dur < 200) ? "." : "-";
        document.getElementById('decoder-preview').innerText = morseBuffer;
        lastUp = Date.now();
    }

    function mapExternalKey() {
        isMapping = true;
        document.getElementById('map-btn').innerText = "PREMI TASTO...";
    }

    setInterval(() => {
        if(morseBuffer !== "" && (Date.now() - lastUp > 600)) {
            const char = MORSE[morseBuffer] || "?";
            sendMessage(char);
            morseBuffer = "";
            document.getElementById('decoder-preview').innerText = "";
        }
    }, 100);

    function showAdminLogin() {
        document.getElementById('admin-modal').classList.add('show');
        document.getElementById('admin-pwd').value = '';
        document.getElementById('admin-error').style.display = 'none';
        setTimeout(() => document.getElementById('admin-pwd').focus(), 100);
    }
    
    function closeAdminModal() {
        document.getElementById('admin-modal').classList.remove('show');
    }
    
    function checkAdminPassword() {
        const pwd = document.getElementById('admin-pwd').value;
        if(pwd === ADMIN_PASSWORD) {
            closeAdminModal();
            openAdminPanel();
        } else {
            document.getElementById('admin-error').style.display = 'block';
            document.getElementById('admin-pwd').value = '';
        }
    }
    
    function openAdminPanel() {
        document.getElementById('admin-panel').classList.add('show');
        loadAdminData();
    }
    
    function closeAdminPanel() {
        document.getElementById('admin-panel').classList.remove('show');
    }
    
    function loadAdminData() {
        db.ref('admin/background').once('value').then(snap => {
            const bgData = snap.val();
            if(bgData) {
                document.getElementById('bg-preview').src = bgData;
                document.getElementById('bg-preview-container').style.display = 'block';
            }
        });
        
        db.ref('admin/chatOpacity').once('value').then(snap => {
            const opacity = snap.val() || 70;
            document.getElementById('opacity-slider').value = opacity;
            document.getElementById('opacity-value').innerText = opacity;
            applyChatOpacity(opacity);
        });
        
        updateStatistics();
    }
    
    function handleBackgroundUpload(event) {
        const file = event.target.files[0];
        if(!file) return;
        
        if(file.size > 5 * 1024 * 1024) {
            alert('File troppo grande! Max 5MB');
            return;
        }
        
        if(!file.type.startsWith('image/')) {
            alert('Seleziona un\'immagine valida!');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                let width = img.width;
                let height = img.height;
                const maxWidth = 1920;
                const maxHeight = 1080;
                
                if(width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width = width * ratio;
                    height = height * ratio;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                const optimizedData = canvas.toDataURL('image/jpeg', 0.7);
                
                db.ref('admin/background').set(optimizedData);
                
                document.getElementById('bg-preview').src = optimizedData;
                document.getElementById('bg-preview-container').style.display = 'block';
                
                applyBackground(optimizedData);
                
                console.log('‚úÖ Sfondo caricato');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    function applyBackground(dataUrl) {
        document.body.style.backgroundImage = `url(${dataUrl})`;
        document.body.classList.add('has-background');
    }
    
    function removeBackground() {
        if(confirm('Rimuovere lo sfondo?')) {
            db.ref('admin/background').remove();
            document.body.style.backgroundImage = 'none';
            document.body.classList.remove('has-background');
            document.getElementById('bg-preview-container').style.display = 'none';
        }
    }
    
    function updateChatOpacity(value) {
        document.getElementById('opacity-value').innerText = value;
        applyChatOpacity(value);
        db.ref('admin/chatOpacity').set(parseInt(value));
    }
    
    function applyChatOpacity(value) {
        const opacity = value / 100;
        const messagesBox = document.getElementById('messages');
        messagesBox.style.backgroundColor = `rgba(0, 0, 0, ${opacity})`;
        
        if(value < 70) {
            messagesBox.style.backdropFilter = 'blur(10px)';
            messagesBox.style.webkitBackdropFilter = 'blur(10px)';
        } else {
            messagesBox.style.backdropFilter = 'blur(8px)';
            messagesBox.style.webkitBackdropFilter = 'blur(8px)';
        }
    }
    
    function resetOpacity() {
        updateChatOpacity(70);
        document.getElementById('opacity-slider').value = 70;
    }
    
    function testAudioReception() {
        const resultEl = document.getElementById('audio-test-result');
        
        if(!audioCtx) {
            resultEl.innerText = '‚ùå Audio context non inizializzato!';
            resultEl.style.color = '#f00';
            return;
        }
        
        resultEl.innerText = 'üîä Attivazione audio...';
        resultEl.style.color = 'var(--amber)';
        
        if(audioCtx.state === 'suspended') {
            audioCtx.resume().then(() => {
                runAudioTest(resultEl);
            }).catch(err => {
                resultEl.innerText = '‚ùå Errore attivazione: ' + err.message;
                resultEl.style.color = '#f00';
            });
        } else {
            runAudioTest(resultEl);
        }
    }
    
    function runAudioTest(resultEl) {
        resultEl.innerText = 'üéµ Riproduzione SOS (... --- ...)';
        resultEl.style.color = 'var(--amber)';
        
        const sos = ['S', 'O', 'S'];
        let totalDelay = 0;
        
        sos.forEach((char, i) => {
            setTimeout(() => {
                console.log('üß™ Test audio:', char);
                playMorseChar(char);
            }, totalDelay);
            
            const morse = CHAR_TO_MORSE[char];
            if(morse) {
                const duration = morse.split('').reduce((sum, s) => {
                    return sum + (s === '.' ? DOT_DURATION : DASH_DURATION) + SYMBOL_GAP;
                }, 0);
                totalDelay += duration + LETTER_GAP;
            }
        });
        
        setTimeout(() => {
            resultEl.innerText = '‚úÖ Test completato! Se hai sentito 3 segnali (... --- ...), l\'audio funziona!';
            resultEl.style.color = 'var(--green)';
        }, totalDelay + 500);
    }
    
    function updateStatistics() {
        db.ref('chat').once('value').then(snap => {
            const messages = [];
            snap.forEach(child => messages.push(child.val()));
            
            document.getElementById('stat-messages').innerText = messages.length;
            
            const uniqueUsers = [...new Set(messages.map(m => m.user))];
            document.getElementById('stat-users').innerText = uniqueUsers.length;
            
            if(messages.length > 0) {
                const lastMsg = messages[messages.length - 1];
                const date = new Date(lastMsg.time);
                document.getElementById('stat-last').innerText = date.toLocaleString('it-IT');
            }
        });
        
        db.ref('users').once('value').then(snap => {
            document.getElementById('stat-online').innerText = snap.numChildren();
        });
        
        db.ref('admin/stats').once('value').then(snap => {
            const stats = snap.val() || {};
            document.getElementById('stat-sessions').innerText = stats.totalSessions || 0;
            document.getElementById('stat-chars').innerText = stats.totalChars || 0;
        });
    }
    
    function resetStats() {
        if(confirm('RESET PERMANENTE delle statistiche?')) {
            db.ref('admin/stats').set({
                totalSessions: 0,
                totalChars: 0
            });
            updateStatistics();
        }
    }
    
    function trackSession() {
        sessionStartTime = Date.now();
        db.ref('admin/stats/totalSessions').transaction((current) => (current || 0) + 1);
    }

    const keyEl = document.getElementById('key');
    
    keyEl.addEventListener('mousedown', down);
    window.addEventListener('mouseup', up);
    
    keyEl.addEventListener('touchstart', (e) => { 
        e.preventDefault(); 
        down(e); 
    });
    window.addEventListener('touchend', up);
    
    window.addEventListener('keydown', (e) => { 
        if(!e.repeat) down(e); 
    });
    window.addEventListener('keyup', up);

    document.body.addEventListener('touchmove', (e) => {
        if(e.target.id === 'key' || e.target.closest('#morse-pad')) {
            e.preventDefault();
        }
    }, { passive: false });

    document.addEventListener('DOMContentLoaded', () => {
        const adminPwd = document.getElementById('admin-pwd');
        if(adminPwd) {
            adminPwd.addEventListener('keypress', (e) => {
                if(e.key === 'Enter') checkAdminPassword();
            });
        }
    });

    console.log('üîß MORSE-LINK LIVE - FIREBASE MODE');
    console.log('üì° Pronto per la connessione globale...');

</script>
</body>
</html>