<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MORSE-LINK LIVE | Radio in Vetta</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Real-time Morse Code communication platform for amateur radio operators worldwide">
    <meta name="theme-color" content="#ffb000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MORSE-LINK">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --amber: #ffb000; 
            --bg-black: #0a0a0a; 
            --panel: #1e1e1e; 
            --green: #0f0;
            --blue: #0af;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body { 
            background: var(--bg-black); 
            color: var(--amber); 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            overflow: hidden;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        @media (max-width: 768px) {
            body {
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
                overflow-x: hidden;
            }
        }
        
        #login-overlay { 
            position: fixed; 
            inset: 0; 
            background: var(--bg-black); 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            gap: 15px;
        }
        
        #login-overlay h2 {
            color: var(--amber);
            text-shadow: 0 0 10px var(--amber);
            margin: 0;
        }
        
        .online-badge {
            background: #0a3d0a;
            color: var(--green);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 1px solid var(--green);
        }
        
        header { 
            background: var(--panel); 
            padding: 10px; 
            border-bottom: 2px solid var(--amber); 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }
        
        body.has-background header {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .header-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        #main { 
            display: grid; 
            grid-template-columns: 160px 1fr 300px; 
            flex: 1; 
            overflow: hidden;
            position: relative;
            min-height: 0;
            gap: 0;
        }
        
        @media (max-width: 768px) {
            #main {
                display: block;
                overflow: visible;
                flex: none;
                height: auto;
                min-height: 0;
                position: relative;
            }
        }
        
        #main::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(10, 10, 10, 0.7);
            z-index: 0;
            pointer-events: none;
            display: none;
        }
        
        body.has-background #main::before {
            display: block;
        }
        
        #sidebar, #morse-section, #text-chat-section {
            position: relative;
            z-index: 1;
        }
        
        #sidebar { 
            border-right: 1px solid #333; 
            padding: 10px; 
            overflow-y: auto;
            background: var(--panel);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        @media (max-width: 768px) {
            #sidebar {
                display: none;
            }
        }
        
        #morse-section { 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }
        
        #text-chat-section {
            border-left: 1px solid #333;
            background: var(--panel);
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
            min-height: 200px;
            padding-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            #text-chat-section {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                border-left: none;
                border-top: 1px solid #333;
                min-height: 250px;
                height: 250px;
                flex-shrink: 0;
                padding-bottom: 30px;
            }
        }
        
        .section-title {
            font-size: 0.9rem;
            font-weight: bold;
            padding: 8px;
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        
        #messages { 
            flex: 1; 
            background: rgba(0, 0, 0, 0.7); 
            border: 1px solid #333; 
            padding: 10px; 
            overflow-y: auto; 
            overflow-x: hidden;
            margin-bottom: 10px; 
            font-size: 1.2rem;
            line-height: 1.5;
            -webkit-overflow-scrolling: touch;
            transition: background-color 0.3s ease;
            min-height: 0;
        }
        
        #text-messages {
            flex: 1;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
            margin-bottom: 10px;
            font-size: 0.95rem;
            line-height: 1.4;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }
        
        #messages.hide-text .msg {
            display: none;
        }
        
        #messages.hide-text::after {
            content: '‚ö° MORSE AUDIO ONLY ‚ö°';
            display: block;
            text-align: center;
            padding: 20px;
            color: var(--amber);
            font-size: 1.1rem;
        }
        
        .msg {
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(255, 176, 0, 0.05);
            border-left: 3px solid var(--amber);
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }
        
        .text-msg {
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(10, 175, 255, 0.08);
            border-left: 3px solid var(--blue);
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }
        
        .text-msg .user {
            color: var(--blue);
            font-weight: bold;
            margin-right: 8px;
        }
        
        .text-msg .time {
            color: #666;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user {
            color: var(--green);
            font-weight: bold;
        }
        
        .time {
            color: #666;
            font-size: 0.8rem;
        }
        
        #morse-pad {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px 0;
            flex-shrink: 0;
        }
        
        #key { 
            background: var(--amber); 
            color: #000; 
            border: 3px solid var(--amber); 
            padding: 25px; 
            font-size: 1.3rem; 
            font-weight: bold; 
            cursor: pointer; 
            user-select: none;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: all 0.1s ease;
            touch-action: none;
            text-align: center;
        }
        
        #key:active, #key.pressed { 
            background: #fff; 
            box-shadow: 0 0 20px var(--amber); 
            transform: scale(0.98);
        }
        
        @media (max-width: 768px) {
            #key {
                padding: 30px;
                font-size: 1.4rem;
                border-radius: 15px;
            }
        }
        
        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .controls button, input[type="text"], input[type="password"], select {
            background: #000;
            color: var(--amber);
            border: 2px solid var(--amber);
            padding: 8px 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            border-radius: 5px;
            transition: all 0.2s;
        }
        
        .controls button:hover {
            background: var(--amber);
            color: #000;
            box-shadow: 0 0 10px rgba(255, 176, 0, 0.5);
        }
        
        .controls button:active {
            transform: scale(0.95);
        }
        
        input[type="text"], input[type="password"] {
            flex: 1;
            min-width: 150px;
            cursor: text;
        }
        
        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #fff;
            box-shadow: 0 0 10px rgba(255, 176, 0, 0.3);
        }
        
        #user-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .user-item {
            padding: 5px 8px;
            background: #000;
            border-left: 3px solid var(--green);
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .online-indicator {
            width: 8px;
            height: 8px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        #qrm-status {
            padding: 8px 12px;
            background: #000;
            border: 2px solid #666;
            border-radius: 5px;
            font-size: 0.85rem;
            color: #666;
        }
        
        #qrm-status.active {
            color: #f90;
            border-color: #f90;
            animation: pulse 1s infinite;
        }
        
        #ai-status {
            padding: 8px 12px;
            background: #000;
            border: 2px solid #666;
            border-radius: 5px;
            font-size: 0.85rem;
            color: #666;
        }
        
        #ai-status.active {
            color: var(--blue);
            border-color: var(--blue);
            animation: pulse 1.5s infinite;
        }
        
        .audio-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 176, 0, 0.95);
            color: #000;
            padding: 30px 50px;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 2000;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 176, 0, 0.7);
            animation: popIn 0.3s ease;
        }
        
        @keyframes popIn {
            from {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1500;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--panel);
            border: 3px solid var(--amber);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(255, 176, 0, 0.5);
        }
        
        .modal-content h3 {
            color: var(--amber);
            margin-top: 0;
            text-align: center;
            text-shadow: 0 0 10px var(--amber);
        }
        
        .error {
            color: #f00;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }
        
        .help-section {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-left: 3px solid var(--amber);
            border-radius: 5px;
        }
        
        .help-section h4 {
            color: var(--amber);
            margin-top: 0;
        }
        
        .help-section ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .help-section li {
            margin: 8px 0;
            line-height: 1.5;
        }
        
        .admin-panel {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1600;
            overflow-y: auto;
            padding: 20px;
        }
        
        .admin-panel.show {
            display: block;
        }
        
        .admin-content {
            max-width: 800px;
            margin: 0 auto;
            background: var(--panel);
            border: 3px solid var(--green);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
        }
        
        .admin-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 10px;
        }
        
        .admin-section h4 {
            color: var(--green);
            margin-top: 0;
            border-bottom: 2px solid var(--green);
            padding-bottom: 10px;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .stat-box {
            background: #000;
            border: 2px solid var(--amber);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-box .value {
            font-size: 2rem;
            color: var(--amber);
            font-weight: bold;
        }
        
        .stat-box .label {
            color: #888;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }
        
        input[type="range"] {
            flex: 1;
            height: 8px;
            background: #333;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--amber);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #fff;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--amber);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #fff;
        }
        
        #bg-preview-container {
            display: none;
            margin: 15px 0;
            text-align: center;
        }
        
        #bg-preview {
            max-width: 100%;
            max-height: 200px;
            border: 2px solid var(--amber);
            border-radius: 10px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .btn-danger {
            background: #600;
            border-color: #f00;
            color: #f00;
        }
        
        .btn-danger:hover {
            background: #f00;
            color: #fff;
        }
        
        .btn-success {
            background: #060;
            border-color: var(--green);
            color: var(--green);
        }
        
        .btn-success:hover {
            background: var(--green);
            color: #000;
        }
        
        @media (max-width: 768px) {
            .modal-content, .admin-content {
                padding: 20px;
                width: 95%;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn-group button {
                width: 100%;
            }
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 176, 0, 0.3);
            border-radius: 50%;
            border-top-color: var(--amber);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Miglioramenti accessibilit√† */
        button:focus-visible,
        input:focus-visible {
            outline: 3px solid var(--amber);
            outline-offset: 2px;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body>
    <div id="login-overlay">
        <h2>üîó MORSE-LINK LIVE üîó</h2>
        <div class="online-badge">
            <span id="online-count">0</span> ONLINE
        </div>
        <input type="text" id="callsign-input" placeholder="Your CALLSIGN" maxlength="15" aria-label="Enter your callsign">
        <button onclick="login()" style="padding: 12px 30px; font-size: 1.1rem;">JOIN</button>
    </div>

    <header>
        <div class="header-left">
            <div style="font-size: 1.2rem; font-weight: bold; text-shadow: 0 0 10px var(--amber);">
                üîó MORSE-LINK LIVE
            </div>
            <div style="font-size: 0.85rem; color: #888;">
                <span id="username-display"></span> | <span id="online-count-header">0</span> ONLINE
            </div>
        </div>
        
        <div class="header-buttons">
            <button onclick="showHelp()" title="Help">‚ùì</button>
            <button onclick="toggleTextMode()" id="text-mode-btn" title="Toggle Text Display">üëÅÔ∏è</button>
            <button onclick="toggleQRM()" id="qrm-btn" title="Toggle QRM/QRN">üìª</button>
            <button onclick="toggleAI()" id="ai-btn" title="Virtual QSO">ü§ñ</button>
            <button onclick="showAdminLogin()" title="Admin Panel">‚öôÔ∏è</button>
        </div>
    </header>

    <div id="main">
        <div id="sidebar">
            <div class="section-title">üë• OPERATORS</div>
            <div id="user-list"></div>
            <div style="margin-top: auto; padding-top: 10px; font-size: 0.75rem; color: #666; text-align: center;">
                Radio in Vetta<br>IU2RPQ
            </div>
        </div>

        <div id="morse-section">
            <div class="section-title">‚ö° MORSE CHAT ‚ö°</div>
            
            <div id="messages" role="log" aria-live="polite" aria-label="Morse messages"></div>

            <div id="morse-pad">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span id="qrm-status">QRM: OFF</span>
                    <span id="ai-status">AI: OFF</span>
                </div>
                
                <button id="key" aria-label="Morse key - press and hold to transmit">
                    üîë PRESS TO TRANSMIT
                </button>
                
                <div class="controls">
                    <button onclick="toggleMorseKeyboard()" id="kbd-btn" title="Toggle Keyboard Morse">‚å®Ô∏è</button>
                    <button onclick="showKeyConfig()" title="Configure Keyboard Key">üîß</button>
                    <span id="mapped-key-display" style="color: #888; font-size: 0.85rem;">Key: SPACE</span>
                    <button onclick="clearChat()" title="Clear Morse Chat">üóëÔ∏è</button>
                </div>
            </div>
        </div>

        <div id="text-chat-section">
            <div class="section-title">üí¨ TEXT CHAT</div>
            
            <div id="text-messages" role="log" aria-live="polite" aria-label="Text messages"></div>
            
            <div class="controls">
                <input type="text" id="text-input" placeholder="Type message..." maxlength="200" aria-label="Text message input">
                <button onclick="sendTextMessage()" title="Send Text Message">üì§</button>
            </div>
        </div>
    </div>

    <!-- Modal Help -->
    <div id="help-modal" class="modal" role="dialog" aria-labelledby="help-title">
        <div class="modal-content">
            <h3 id="help-title">üìñ MORSE-LINK LIVE HELP</h3>
            
            <div class="help-section">
                <h4>üîë Morse Transmission</h4>
                <ul>
                    <li><strong>Mouse/Touch:</strong> Press and hold the yellow button</li>
                    <li><strong>Keyboard:</strong> Enable with ‚å®Ô∏è button, then use SPACE (or configured key)</li>
                    <li><strong>Timing:</strong> Short press = dot (¬∑), long press = dash (‚îÄ)</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h4>üéõÔ∏è Features</h4>
                <ul>
                    <li><strong>üëÅÔ∏è</strong> Toggle text display in Morse chat</li>
                    <li><strong>üìª</strong> Enable QRM/QRN atmospheric noise</li>
                    <li><strong>ü§ñ</strong> Practice with AI Virtual QSO</li>
                    <li><strong>üí¨</strong> Send text messages alongside Morse</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h4>‚ö° Audio</h4>
                <p>If you can't hear incoming Morse signals, click the "ATTIVA AUDIO" alert that appears when someone transmits.</p>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeHelp()" style="padding: 10px 30px;">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- Modal Key Config -->
    <div id="key-config-modal" class="modal" role="dialog" aria-labelledby="keyconfig-title">
        <div class="modal-content">
            <h3 id="keyconfig-title">üîß KEYBOARD KEY CONFIG</h3>
            <p style="text-align: center; margin: 20px 0;">Press the key you want to use for Morse transmission:</p>
            <div style="text-align: center; font-size: 2rem; color: var(--amber); margin: 20px 0;" id="key-display">
                SPACE
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeKeyConfig()" style="padding: 10px 30px;">DONE</button>
            </div>
        </div>
    </div>

    <!-- Modal Admin Login -->
    <div id="admin-modal" class="modal" role="dialog" aria-labelledby="admin-login-title">
        <div class="modal-content">
            <h3 id="admin-login-title">üîê ADMIN ACCESS</h3>
            <input type="password" id="admin-pwd" placeholder="Admin Password" aria-label="Admin password">
            <div class="error" id="admin-error">‚ùå Wrong password!</div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="checkAdminPassword()" style="flex: 1;">LOGIN</button>
                <button onclick="closeAdminModal()" style="flex: 1;">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- Panel Admin -->
    <div id="admin-panel" class="admin-panel" role="dialog" aria-labelledby="admin-panel-title">
        <div class="admin-content">
            <h3 id="admin-panel-title" style="color: var(--green); text-align: center;">‚öôÔ∏è ADMIN PANEL ‚öôÔ∏è</h3>
            
            <div class="admin-section">
                <h4>üìä Statistics</h4>
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="value" id="stat-morse">0</div>
                        <div class="label">Morse Messages</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="stat-text">0</div>
                        <div class="label">Text Messages</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="stat-users">0</div>
                        <div class="label">Total Users</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="stat-online">0</div>
                        <div class="label">Online Now</div>
                    </div>
                </div>
                <button onclick="resetStats()" class="btn-success">üîÑ Refresh</button>
            </div>
            
            <div class="admin-section">
                <h4>üñºÔ∏è Background Image</h4>
                <input type="file" id="bg-upload" accept="image/*" onchange="handleBackgroundUpload(event)" style="margin: 10px 0;">
                <div id="bg-preview-container">
                    <img id="bg-preview" alt="Background preview">
                </div>
                <div class="btn-group">
                    <button onclick="removeBackground()" class="btn-danger">üóëÔ∏è Remove Background</button>
                </div>
            </div>
            
            <div class="admin-section">
                <h4>üé® Chat Opacity</h4>
                <div class="slider-container">
                    <span>0%</span>
                    <input type="range" id="opacity-slider" min="0" max="100" value="70" oninput="updateChatOpacity(this.value)">
                    <span>100%</span>
                    <span id="opacity-value" style="color: var(--amber); font-weight: bold;">70</span>
                </div>
                <button onclick="resetOpacity()">‚Ü©Ô∏è Reset to Default (70%)</button>
            </div>
            
            <div class="admin-section">
                <h4>üéµ Test Audio Reception</h4>
                <p style="color: #888; font-size: 0.9rem;">Test if you can hear incoming Morse signals (plays SOS)</p>
                <button onclick="testAudioReception()" class="btn-success">‚ñ∂Ô∏è Test Audio (SOS)</button>
                <div id="audio-test-result" style="margin-top: 10px; text-align: center; font-weight: bold;"></div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="closeAdminPanel()" style="padding: 12px 40px;">‚úÖ CLOSE</button>
            </div>
        </div>
    </div>

<script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MORSE-LINK LIVE - OTTIMIZZATO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAQE9kHNcBU0g-AjKF-LBfn8oMxKnSvNqE",
        authDomain: "morse-link-live.firebaseapp.com",
        databaseURL: "https://morse-link-live-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "morse-link-live",
        storageBucket: "morse-link-live.firebasestorage.app",
        messagingSenderId: "644043933903",
        appId: "1:644043933903:web:fd12ae3f2b8b37a5b8f8e7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONSTANTS & STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ADMIN_PASSWORD = 'radioInVettaAdmin2025';
    
    const MORSE_CODE = {
        'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.',
        'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..',
        'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.',
        'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
        'Y': '-.--', 'Z': '--..', '0': '-----', '1': '.----', '2': '..---',
        '3': '...--', '4': '....-', '5': '.....', '6': '-....', '7': '--...',
        '8': '---..', '9': '----.', '.': '.-.-.-', ',': '--..--', '?': '..--..',
        '/': '-..-.', ' ': ' '
    };

    const DOT_TIME = 80;
    const DASH_TIME = DOT_TIME * 3;
    const SYMBOL_GAP = DOT_TIME;
    const LETTER_GAP = DOT_TIME * 3;
    const WORD_GAP = DOT_TIME * 7;

    let audioCtx = null;
    let oscillator = null;
    let gainNode = null;
    let audioActivated = false;
    let currentUser = '';
    let isDown = false;
    let downTime = 0;
    let morseBuffer = '';
    let bufferTimeout = null;
    let textModeEnabled = true;
    let qrmEnabled = false;
    let qrmInterval = null;
    let aiEnabled = false;
    let aiTimeout = null;
    let morseKeyboardEnabled = false;
    let mappedKey = 'Space';
    let userListeners = [];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUDIO SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function initAudio() {
        if (audioCtx) return;
        
        // Verifica supporto browser
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) {
            console.error('‚ùå AudioContext non supportato da questo browser');
            alert('‚ö†Ô∏è Il tuo browser non supporta l\'audio Web Audio API.\nProva con Chrome, Firefox o Edge.');
            return;
        }
        
        try {
            audioCtx = new AudioContext();
            gainNode = audioCtx.createGain();
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            console.log('üéµ Audio Context inizializzato:', audioCtx.state);
        } catch (err) {
            console.error('‚ùå Errore inizializzazione audio:', err);
        }
    }

    function playTone(duration) {
        if (!audioCtx) return Promise.resolve();
        
        return new Promise(resolve => {
            try {
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                
                oscillator = audioCtx.createOscillator();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(700, audioCtx.currentTime);
                oscillator.connect(gainNode);
                
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.005);
                
                oscillator.start(audioCtx.currentTime);
                
                setTimeout(() => {
                    if (oscillator) {
                        gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.005);
                        oscillator.stop(audioCtx.currentTime + 0.01);
                        oscillator.disconnect();
                        oscillator = null;
                    }
                    resolve();
                }, duration);
            } catch (err) {
                console.error('‚ùå Errore riproduzione tono:', err);
                resolve();
            }
        });
    }

    async function playMorseChar(char) {
        const code = MORSE_CODE[char.toUpperCase()];
        if (!code) return;
        
        for (let symbol of code) {
            if (symbol === '.') {
                await playTone(DOT_TIME);
            } else if (symbol === '-') {
                await playTone(DASH_TIME);
            }
            await new Promise(r => setTimeout(r, SYMBOL_GAP));
        }
    }

    async function playMorseString(text) {
        const words = text.split(' ');
        for (let i = 0; i < words.length; i++) {
            const word = words[i];
            for (let j = 0; j < word.length; j++) {
                await playMorseChar(word[j]);
                if (j < word.length - 1) {
                    await new Promise(r => setTimeout(r, LETTER_GAP));
                }
            }
            if (i < words.length - 1) {
                await new Promise(r => setTimeout(r, WORD_GAP));
            }
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QRM/QRN SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function startQRM() {
        if (qrmInterval || !audioCtx) return;
        
        qrmInterval = setInterval(() => {
            if (Math.random() < 0.3) {
                const freq = 300 + Math.random() * 800;
                const duration = 50 + Math.random() * 150;
                
                try {
                    if (audioCtx.state === 'suspended') audioCtx.resume();
                    
                    const qrmOsc = audioCtx.createOscillator();
                    qrmOsc.type = 'sawtooth';
                    qrmOsc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                    
                    const qrmGain = audioCtx.createGain();
                    qrmGain.gain.setValueAtTime(0, audioCtx.currentTime);
                    qrmGain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 0.01);
                    
                    qrmOsc.connect(qrmGain);
                    qrmGain.connect(audioCtx.destination);
                    qrmOsc.start();
                    
                    setTimeout(() => {
                        qrmGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.02);
                        qrmOsc.stop(audioCtx.currentTime + 0.03);
                    }, duration);
                } catch (err) {
                    console.error('QRM error:', err);
                }
            }
        }, 500);
    }

    function stopQRM() {
        if (qrmInterval) {
            clearInterval(qrmInterval);
            qrmInterval = null;
        }
    }

    function toggleQRM() {
        qrmEnabled = !qrmEnabled;
        const btn = document.getElementById('qrm-btn');
        const status = document.getElementById('qrm-status');
        
        if (qrmEnabled) {
            btn.style.background = '#f90';
            btn.style.color = '#000';
            status.classList.add('active');
            status.innerText = 'QRM: ON';
            startQRM();
        } else {
            btn.style.background = '';
            btn.style.color = '';
            status.classList.remove('active');
            status.innerText = 'QRM: OFF';
            stopQRM();
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI VIRTUAL QSO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const AI_RESPONSES = [
        'CQ CQ CQ DE AI OM',
        'GM ES TNX FER CALL',
        'UR RST 599 599',
        'QTH CLOUD SERVER HI',
        'WX SUNNY ES WARM',
        'RIG 100W ANT DIPOLE',
        'NAME CLAUDE OP AI',
        'AGE UNDEFINED HI HI',
        '73 ES GL OM',
        'QRZ DE AI K'
    ];

    function scheduleAIResponse() {
        if (!aiEnabled) return;
        
        const delay = 8000 + Math.random() * 12000;
        aiTimeout = setTimeout(() => {
            const response = AI_RESPONSES[Math.floor(Math.random() * AI_RESPONSES.length)];
            const timestamp = new Date().toISOString();
            
            db.ref('chat').push({
                user: 'ü§ñ AI-OP',
                text: response,
                time: timestamp
            });
            
            scheduleAIResponse();
        }, delay);
    }

    function toggleAI() {
        aiEnabled = !aiEnabled;
        const btn = document.getElementById('ai-btn');
        const status = document.getElementById('ai-status');
        
        if (aiEnabled) {
            btn.style.background = 'var(--blue)';
            btn.style.color = '#000';
            status.classList.add('active');
            status.innerText = 'AI: ON';
            scheduleAIResponse();
        } else {
            btn.style.background = '';
            btn.style.color = '';
            status.classList.remove('active');
            status.innerText = 'AI: OFF';
            if (aiTimeout) {
                clearTimeout(aiTimeout);
                aiTimeout = null;
            }
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN & USER MANAGEMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function login() {
        const input = document.getElementById('callsign-input').value.trim().toUpperCase();
        if (!input || input.length < 2) {
            alert('‚ö†Ô∏è Inserisci un callsign valido (min 2 caratteri)');
            return;
        }
        
        currentUser = input;
        document.getElementById('username-display').innerText = currentUser;
        document.getElementById('login-overlay').style.display = 'none';
        
        // Presenza online
        const userRef = db.ref('users/' + currentUser);
        userRef.set({ online: true, lastSeen: firebase.database.ServerValue.TIMESTAMP });
        userRef.onDisconnect().remove();
        
        initializeApp();
    }

    function initializeApp() {
        initAudio();
        loadBackground();
        loadChatOpacity();
        listenToMessages();
        listenToTextMessages();
        listenToOnlineUsers();
        
        console.log('‚úÖ MORSE-LINK LIVE inizializzato per', currentUser);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE LISTENERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function listenToMessages() {
        db.ref('chat').limitToLast(50).on('child_added', snap => {
            const msg = snap.val();
            if (!msg) return;
            
            const div = document.createElement('div');
            div.className = 'msg';
            
            const time = new Date(msg.time).toLocaleTimeString('it-IT', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            div.innerHTML = `<span class="user">${msg.user}</span> <span class="time">${time}</span><br>${msg.text}`;
            
            const messagesEl = document.getElementById('messages');
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            
            // Riproduci audio se non sei tu
            if (msg.user !== currentUser) {
                playIncomingMorse(msg.text);
            }
        });
    }

    function listenToTextMessages() {
        db.ref('textChat').limitToLast(50).on('child_added', snap => {
            const msg = snap.val();
            if (!msg) return;
            
            const div = document.createElement('div');
            div.className = 'text-msg';
            
            const time = new Date(msg.time).toLocaleTimeString('it-IT', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            div.innerHTML = `<span class="user">${msg.user}</span> <span class="time">${time}</span><br>${msg.text}`;
            
            const textMessagesEl = document.getElementById('text-messages');
            textMessagesEl.appendChild(div);
            textMessagesEl.scrollTop = textMessagesEl.scrollHeight;
        });
    }

    function listenToOnlineUsers() {
        // Cleanup vecchi listeners
        userListeners.forEach(ref => ref.off());
        userListeners = [];
        
        const usersRef = db.ref('users');
        userListeners.push(usersRef);
        
        usersRef.on('value', snap => {
            const users = snap.val() || {};
            const userList = document.getElementById('user-list');
            const count = Object.keys(users).length;
            
            document.getElementById('online-count').innerText = count;
            document.getElementById('online-count-header').innerText = count;
            
            userList.innerHTML = '';
            Object.keys(users).forEach(callsign => {
                const div = document.createElement('div');
                div.className = 'user-item';
                div.innerHTML = `<span class="online-indicator"></span>${callsign}`;
                userList.appendChild(div);
            });
        });
    }

    async function playIncomingMorse(text) {
        if (!audioCtx) {
            showAudioAlert();
            return;
        }
        
        if (audioCtx.state === 'suspended') {
            showAudioAlert();
            return;
        }
        
        await playMorseString(text);
    }

    function showAudioAlert() {
        const existing = document.querySelector('.audio-alert');
        if (existing) return;
        
        const alert = document.createElement('div');
        alert.className = 'audio-alert';
        alert.innerHTML = 'üîä ATTIVA AUDIO<br><small>Clicca per sentire i messaggi</small>';
        alert.onclick = activateAudio;
        document.body.appendChild(alert);
        
        setTimeout(() => {
            alert.style.animation = 'popOut 0.3s ease forwards';
            setTimeout(() => alert.remove(), 300);
        }, 4000);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MORSE KEY HANDLERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function down(e) {
        if (isDown) return;
        
        // Verifica se √® keyboard e se keyboard morse √® attivo
        if (e instanceof KeyboardEvent) {
            if (!morseKeyboardEnabled) return;
            if (e.code !== mappedKey) return;
            
            // BUG FIX: Condizione corretta con OR invece di AND
            if (e.code === 'Space' || e.code === mappedKey) {
                e.preventDefault();
            }
            
            // Previeni se focus su input
            const activeEl = document.activeElement;
            if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
                return;
            }
        }
        
        isDown = true;
        downTime = Date.now();
        
        document.getElementById('key').classList.add('pressed');
        
        initAudio();
        if (audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        
        playTone(10000);
    }

    function up(e) {
        if (!isDown) return;
        
        // Verifica keyboard
        if (e instanceof KeyboardEvent) {
            if (!morseKeyboardEnabled) return;
            if (e.code !== mappedKey) return;
        }
        
        isDown = false;
        const duration = Date.now() - downTime;
        
        document.getElementById('key').classList.remove('pressed');
        
        if (oscillator) {
            gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.005);
            oscillator.stop(audioCtx.currentTime + 0.01);
            oscillator.disconnect();
            oscillator = null;
        }
        
        const symbol = duration < 200 ? '.' : '-';
        morseBuffer += symbol;
        
        clearTimeout(bufferTimeout);
        bufferTimeout = setTimeout(sendMorseMessage, 1500);
    }

    function sendMorseMessage() {
        if (morseBuffer.length === 0) return;
        
        const text = decodeMorse(morseBuffer);
        morseBuffer = '';
        
        if (text) {
            db.ref('chat').push({
                user: currentUser,
                text: text,
                time: new Date().toISOString()
            });
        }
    }

    function decodeMorse(code) {
        const reverseCode = Object.fromEntries(
            Object.entries(MORSE_CODE).map(([k, v]) => [v, k])
        );
        
        const words = code.split('       ');
        const decoded = words.map(word => {
            const letters = word.split('   ');
            return letters.map(letter => reverseCode[letter] || '?').join('');
        }).join(' ');
        
        return decoded;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TEXT CHAT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function sendTextMessage() {
        const input = document.getElementById('text-input');
        const text = input.value.trim();
        
        if (!text) return;
        
        db.ref('textChat').push({
            user: currentUser,
            text: text,
            time: new Date().toISOString()
        });
        
        input.value = '';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UI CONTROLS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function toggleTextMode() {
        textModeEnabled = !textModeEnabled;
        const messagesEl = document.getElementById('messages');
        const btn = document.getElementById('text-mode-btn');
        
        if (textModeEnabled) {
            messagesEl.classList.remove('hide-text');
            btn.style.background = '';
        } else {
            messagesEl.classList.add('hide-text');
            btn.style.background = '#666';
        }
    }

    function toggleMorseKeyboard() {
        morseKeyboardEnabled = !morseKeyboardEnabled;
        const btn = document.getElementById('kbd-btn');
        
        if (morseKeyboardEnabled) {
            btn.style.background = 'var(--amber)';
            btn.style.color = '#000';
            console.log('‚å®Ô∏è Morse Keyboard: ON');
        } else {
            btn.style.background = '';
            btn.style.color = '';
            console.log('‚å®Ô∏è Morse Keyboard: OFF');
        }
    }

    function showKeyConfig() {
        document.getElementById('key-config-modal').classList.add('show');
        document.getElementById('key-display').innerText = mappedKey;
        
        // Temp listener per catturare prossimo key press
        const tempListener = (e) => {
            e.preventDefault();
            mappedKey = e.code;
            document.getElementById('key-display').innerText = e.code;
            document.getElementById('mapped-key-display').innerText = 'Key: ' + e.code;
            window.removeEventListener('keydown', tempListener);
        };
        
        window.addEventListener('keydown', tempListener);
    }

    function closeKeyConfig() {
        document.getElementById('key-config-modal').classList.remove('show');
    }

    function clearChat() {
        if (confirm('Eliminare tutti i messaggi Morse?')) {
            db.ref('chat').remove();
            document.getElementById('messages').innerHTML = '';
        }
    }

    function showHelp() {
        document.getElementById('help-modal').classList.add('show');
    }

    function closeHelp() {
        document.getElementById('help-modal').classList.remove('show');
    }

    async function activateAudio() {
        const alert = document.querySelector('.audio-alert');
        if (alert) alert.remove();
        
        try {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîä ATTIVAZIONE AUDIO...');
            console.log('   Browser:', navigator.userAgent.includes('Chrome') ? 'Chrome' : 'Other');
            
            initAudio();
            
            if (!audioCtx) {
                throw new Error('AudioContext non disponibile');
            }
            
            console.log('   audioCtx.state prima:', audioCtx.state);
            
            if (audioCtx.state === 'suspended') {
                await audioCtx.resume();
                console.log('   audioCtx.state dopo resume:', audioCtx.state);
            }
            
            // Test audio
            await playTone(100);
            await new Promise(r => setTimeout(r, 200));
            await playTone(100);
            
            audioActivated = true;
            
            if (qrmEnabled) startQRM();
            
            console.log('‚úÖ AUDIO COMPLETAMENTE ATTIVATO');
            console.log('   audioCtx.state:', audioCtx.state);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            alert('‚úÖ Audio attivato con successo!\n\nOra puoi sentire i messaggi Morse in arrivo.');
            
        } catch (err) {
            console.error('‚ùå ERRORE ATTIVAZIONE:', err);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            alert('‚ùå Errore attivazione audio:\n' + err.message + '\n\nProva a ricaricare la pagina.');
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADMIN PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showAdminLogin() {
        document.getElementById('admin-modal').classList.add('show');
        document.getElementById('admin-pwd').value = '';
        document.getElementById('admin-error').style.display = 'none';
    }
    
    function closeAdminModal() {
        document.getElementById('admin-modal').classList.remove('show');
    }
    
    function checkAdminPassword() {
        const pwd = document.getElementById('admin-pwd').value;
        if (pwd === ADMIN_PASSWORD) {
            closeAdminModal();
            openAdminPanel();
        } else {
            document.getElementById('admin-error').style.display = 'block';
        }
    }
    
    function openAdminPanel() {
        document.getElementById('admin-panel').classList.add('show');
        loadAdminData();
    }
    
    function closeAdminPanel() {
        document.getElementById('admin-panel').classList.remove('show');
    }
    
    function loadAdminData() {
        // Carica dati in parallelo per ottimizzazione
        Promise.all([
            db.ref('admin/background').once('value'),
            db.ref('admin/chatOpacity').once('value')
        ]).then(([bgSnap, opacitySnap]) => {
            const bgData = bgSnap.val();
            if (bgData) {
                document.getElementById('bg-preview').src = bgData;
                document.getElementById('bg-preview-container').style.display = 'block';
            }
            
            const opacity = opacitySnap.val() || 70;
            document.getElementById('opacity-slider').value = opacity;
            document.getElementById('opacity-value').innerText = opacity;
            applyChatOpacity(opacity);
        });
        
        updateStatistics();
    }
    
    function handleBackgroundUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (file.size > 5 * 1024 * 1024) {
            alert('‚ö†Ô∏è File troppo grande! Max 5MB');
            return;
        }
        
        if (!file.type.startsWith('image/')) {
            alert('‚ö†Ô∏è Solo immagini sono permesse');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                let width = img.width, height = img.height;
                const maxWidth = 1920, maxHeight = 1080;
                
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width *= ratio;
                    height *= ratio;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                const optimizedData = canvas.toDataURL('image/jpeg', 0.7);
                db.ref('admin/background').set(optimizedData);
                
                document.getElementById('bg-preview').src = optimizedData;
                document.getElementById('bg-preview-container').style.display = 'block';
                applyBackground(optimizedData);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    function loadBackground() {
        db.ref('admin/background').once('value').then(snap => {
            const bgData = snap.val();
            if (bgData) {
                applyBackground(bgData);
            }
        });
    }
    
    function applyBackground(dataUrl) {
        document.body.style.backgroundImage = `url(${dataUrl})`;
        document.body.classList.add('has-background');
    }
    
    function removeBackground() {
        if (confirm('‚ö†Ô∏è Rimuovere lo sfondo corrente?')) {
            db.ref('admin/background').remove();
            document.body.style.backgroundImage = 'none';
            document.body.classList.remove('has-background');
            document.getElementById('bg-preview-container').style.display = 'none';
        }
    }
    
    function loadChatOpacity() {
        db.ref('admin/chatOpacity').once('value').then(snap => {
            const opacity = snap.val() || 70;
            applyChatOpacity(opacity);
        });
    }
    
    function updateChatOpacity(value) {
        document.getElementById('opacity-value').innerText = value;
        applyChatOpacity(value);
        db.ref('admin/chatOpacity').set(parseInt(value));
    }
    
    function applyChatOpacity(value) {
        const opacity = value / 100;
        document.getElementById('messages').style.backgroundColor = `rgba(0, 0, 0, ${opacity})`;
        document.getElementById('text-messages').style.backgroundColor = `rgba(0, 0, 0, ${opacity * 0.9})`;
    }
    
    function resetOpacity() {
        updateChatOpacity(70);
        document.getElementById('opacity-slider').value = 70;
    }
    
    async function testAudioReception() {
        const resultEl = document.getElementById('audio-test-result');
        
        try {
            initAudio();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            
            resultEl.innerText = 'üéµ Playing SOS...';
            resultEl.style.color = 'var(--amber)';
            
            await playMorseChar('S');
            await new Promise(r => setTimeout(r, LETTER_GAP));
            await playMorseChar('O');
            await new Promise(r => setTimeout(r, LETTER_GAP));
            await playMorseChar('S');
            
            resultEl.innerText = '‚úÖ Audio OK!';
            resultEl.style.color = 'var(--green)';
        } catch (err) {
            resultEl.innerText = '‚ùå Error: ' + err.message;
            resultEl.style.color = '#f00';
        }
    }
    
    function updateStatistics() {
        Promise.all([
            db.ref('chat').once('value'),
            db.ref('textChat').once('value'),
            db.ref('users').once('value')
        ]).then(([chatSnap, textSnap, usersSnap]) => {
            document.getElementById('stat-morse').innerText = chatSnap.numChildren();
            document.getElementById('stat-text').innerText = textSnap.numChildren();
            document.getElementById('stat-online').innerText = usersSnap.numChildren();
            
            const messages = [];
            textSnap.forEach(child => messages.push(child.val()));
            const uniqueUsers = [...new Set(messages.map(m => m.user))];
            document.getElementById('stat-users').innerText = uniqueUsers.length;
        });
    }
    
    function resetStats() {
        if (confirm('üîÑ Aggiornare le statistiche?')) {
            updateStatistics();
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EVENT LISTENERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const keyEl = document.getElementById('key');
    keyEl.addEventListener('mousedown', down);
    window.addEventListener('mouseup', (e) => up(e));
    
    keyEl.addEventListener('touchstart', (e) => { 
        e.preventDefault(); 
        e.stopPropagation();
        down(e); 
    }, { passive: false });
    
    window.addEventListener('touchend', (e) => {
        if (isDown) up(e);
    }, { passive: false });
    
    window.addEventListener('keydown', (e) => { 
        if (!e.repeat) down(e);
    });
    
    window.addEventListener('keyup', (e) => up(e));

    // Previeni scroll durante touch su key
    document.body.addEventListener('touchmove', (e) => {
        if (e.target.id === 'key' || e.target.closest('#morse-pad')) {
            e.preventDefault();
        }
    }, { passive: false });
    
    // Text chat handlers
    document.addEventListener('DOMContentLoaded', () => {
        const textInput = document.getElementById('text-input');
        if (textInput) {
            textInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendTextMessage();
                }
            });
            
            // Disabilita Morse keyboard quando focus su input
            textInput.addEventListener('focus', () => {
                if (morseKeyboardEnabled) {
                    toggleMorseKeyboard();
                    console.log('üí¨ Focus su input ‚Üí Morse Keyboard OFF');
                }
            });
        }
        
        // Admin password field enter
        const adminPwd = document.getElementById('admin-pwd');
        if (adminPwd) {
            adminPwd.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    checkAdminPassword();
                }
            });
        }
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (currentUser) {
            db.ref('users/' + currentUser).remove();
        }
        stopQRM();
        if (aiTimeout) clearTimeout(aiTimeout);
        if (audioCtx) audioCtx.close();
    });

    console.log('üîß MORSE-LINK LIVE - VERSIONE OTTIMIZZATA CARICATA');
</script>
</body>
</html>
