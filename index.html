<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MORSE-LINK LIVE | Radio in Vetta</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Real-time Morse Code communication platform for amateur radio operators worldwide">
    <meta name="theme-color" content="#ffb000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MORSE-LINK">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --amber: #ffb000; 
            --bg-black: #0a0a0a; 
            --panel: #1e1e1e; 
            --green: #0f0;
            --blue: #0af;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body { 
            background: var(--bg-black); 
            color: var(--amber); 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            overflow: hidden;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        @media (max-width: 768px) {
            body {
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
                overflow-x: hidden;
            }
        }
        
        #login-overlay { 
            position: fixed; 
            inset: 0; 
            background: var(--bg-black); 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            gap: 15px;
        }
        
        #login-overlay h2 {
            color: var(--amber);
            text-shadow: 0 0 10px var(--amber);
            margin: 0;
        }
        
        .online-badge {
            background: #0a3d0a;
            color: var(--green);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 1px solid var(--green);
        }
        
        header { 
            background: var(--panel); 
            padding: 10px; 
            border-bottom: 2px solid var(--amber); 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }
        
        body.has-background header {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .header-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        #main { 
            display: grid; 
            grid-template-columns: 160px 1fr 300px; 
            flex: 1; 
            overflow: hidden;
            position: relative;
            min-height: 0;
            gap: 0;
        }
        
        @media (max-width: 768px) {
            #main {
                display: block;
                overflow: visible;
                flex: none;
                height: auto;
                min-height: 0;
                position: relative;
            }
        }
        
        #main::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(10, 10, 10, 0.7);
            z-index: 0;
            pointer-events: none;
            display: none;
        }
        
        body.has-background #main::before {
            display: block;
        }
        
        #sidebar, #morse-section, #text-chat-section {
            position: relative;
            z-index: 1;
        }
        
        #sidebar { 
            border-right: 1px solid #333; 
            padding: 10px; 
            overflow-y: auto;
            background: var(--panel);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        #morse-section { 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }
        
        #text-chat-section {
            border-left: 1px solid #333;
            background: var(--panel);
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
            min-height: 200px;
            padding-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            #text-chat-section {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                border-left: none;
                border-top: 1px solid #333;
                min-height: 250px;
                height: 250px;
                flex-shrink: 0;
                padding-bottom: 30px;
            }
        }
        
        .section-title {
            font-size: 0.9rem;
            font-weight: bold;
            padding: 8px;
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        
        #messages { 
            flex: 1; 
            background: rgba(0, 0, 0, 0.7); 
            border: 1px solid #333; 
            padding: 10px; 
            overflow-y: auto; 
            overflow-x: hidden;
            margin-bottom: 10px; 
            font-size: 1.2rem;
            line-height: 1.5;
            -webkit-overflow-scrolling: touch;
            transition: background-color 0.3s ease;
            min-height: 0;
        }
        
        #text-messages {
            flex: 1;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
            margin-bottom: 10px;
            font-size: 0.95rem;
            line-height: 1.4;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }
        
        #messages.hide-text .msg {
            display: none;
        }
        
        #messages.hide-text::after {
            content: 'üîá MODALIT√Ä SOLO AUDIO';
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #666;
            font-size: 1rem;
        }
        
        body.has-background #messages,
        body.has-background #text-messages {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        #decoder-preview { 
            height: 25px; 
            font-size: 1.3rem; 
            text-align: center;
            color: var(--green);
            font-weight: bold;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        
        #morse-pad { 
            height: 140px; 
            background: var(--panel); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            border-radius: 10px; 
            position: relative;
            border: 1px solid #333;
            flex-shrink: 0;
        }
        
        #key { 
            width: 100px; 
            height: 100px; 
            border: 4px solid var(--amber); 
            border-radius: 50%; 
            cursor: pointer; 
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            transition: background 0.05s, transform 0.05s;
        }
        
        #key:active { 
            background: var(--amber); 
            box-shadow: 0 0 20px var(--amber);
            transform: scale(0.95);
        }
        
        #text-input-area {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            #text-input-area {
                display: block;
                width: 100%;
            }
            
            #text-input-area input {
                width: 100%;
                display: block;
                margin-bottom: 10px;
            }
            
            #text-input-area button {
                width: 100%;
                display: block;
            }
        }
        
        #text-input {
            flex: 1;
            background: #000;
            border: 1px solid var(--blue);
            color: var(--blue);
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: none;
            height: 40px;
        }
        
        /* Impedisce zoom automatico su iPhone */
        @media screen and (max-width: 768px) {
            #text-input {
                font-size: 16px;
            }
        }
        
        #text-send {
            background: var(--blue);
            border: 2px solid var(--blue);
            color: #000;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
        }
        
        #text-send:hover {
            background: #08d;
        }
        
        #text-send:active {
            transform: scale(0.95);
        }
        
        #morse-keyboard-toggle {
            transition: all 0.3s;
            cursor: pointer;
        }
        
        #morse-keyboard-toggle:hover {
            opacity: 0.9;
        }
        
        #morse-keyboard-toggle:active {
            transform: scale(0.98);
        }
        
        .user-tag { 
            display: block; 
            padding: 5px; 
            color: var(--green); 
            border-bottom: 1px solid #222;
            font-size: 0.8rem;
        }
        
        .msg { 
            margin-bottom: 10px; 
            border-left: 2px solid var(--amber); 
            padding-left: 8px;
            word-wrap: break-word;
        }
        
        .text-msg {
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(0, 170, 255, 0.1);
            border-left: 3px solid var(--blue);
            border-radius: 5px;
            word-wrap: break-word;
        }
        
        .text-msg .author {
            font-weight: bold;
            color: var(--blue);
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        
        .text-msg .content {
            color: #ddd;
            font-size: 0.9rem;
        }
        
        .text-msg .time {
            font-size: 0.7rem;
            color: #666;
            margin-top: 5px;
        }
        
        .input-box { 
            background: #000; 
            border: 1px solid var(--amber); 
            color: var(--amber); 
            padding: 10px; 
            margin: 5px;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            width: 100%;
        }
        
        button {
            background: var(--panel);
            color: var(--amber);
            border: 2px solid var(--amber);
            padding: 10px 16px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        button:hover {
            background: var(--amber);
            color: #000;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        .btn-green {
            background: #0f0;
            border-color: #0f0;
            color: #000;
            font-weight: bold;
        }
        
        .btn-green:hover {
            background: #0c0;
        }
        
        .btn-green.activated {
            background: #666;
            border-color: #666;
            color: #aaa;
            cursor: not-allowed;
        }
        
        #settings-modal, #admin-modal, #admin-panel {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #settings-modal.show, #admin-modal.show, #admin-panel.show {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--panel);
            border: 2px solid var(--amber);
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 100%;
            position: relative;
        }
        
        .panel-content {
            background: var(--panel);
            border: 2px solid var(--amber);
            padding: 20px;
            border-radius: 10px;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #333;
        }
        
        .setting-row:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            font-size: 1rem;
            color: var(--amber);
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #333;
            border-radius: 15px;
            cursor: pointer;
            border: 2px solid #555;
            transition: all 0.3s;
        }
        
        .toggle-switch.active {
            background: var(--green);
            border-color: var(--green);
        }
        
        .toggle-slider {
            position: absolute;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            left: 32px;
        }
        
        .stat-box {
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .stat-label {
            color: #888;
            font-size: 0.9rem;
        }
        
        .stat-value {
            color: var(--amber);
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .upload-zone {
            border: 2px dashed #666;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-zone:hover {
            border-color: var(--amber);
            background: rgba(255, 176, 0, 0.1);
        }
        
        .bg-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border: 2px solid var(--amber);
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f00;
            border-color: #f00;
            color: #fff;
            padding: 5px 15px;
            font-size: 1.2rem;
            line-height: 1;
        }
        
        .close-btn:hover {
            background: #c00;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #333;
            border-radius: 5px;
            outline: none;
            width: 100%;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--amber);
            border-radius: 50%;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--amber);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        @media (max-width: 1024px) {
            #main {
                grid-template-columns: 140px 1fr 250px;
            }
            
            .user-tag {
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 768px) {
            body {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                height: auto;
                min-height: 100vh;
                scroll-padding-bottom: 50px;
                padding-bottom: 80px;
            }
            
            #main { 
                display: block;
                height: auto;
                min-height: 0;
                overflow: visible;
            }
            
            #sidebar { 
                display: block;
                border-right: none;
                border-bottom: 1px solid #333;
                height: auto;
                min-height: 60px;
                max-height: none;
                padding: 8px;
                margin-bottom: 10px;
            }
            
            #morse-section {
                display: block;
                height: auto;
                min-height: 0;
                overflow: visible;
                margin-bottom: 10px;
            }
            
            #text-chat-section {
                display: block !important;
                border-left: none;
                border-top: 2px solid var(--blue);
                height: auto;
                min-height: 0;
                max-height: none;
                background: rgba(30, 30, 30, 0.98);
                overflow: visible;
                padding: 10px;
                padding-bottom: 80px;
                margin-bottom: 60px;
            }
            
            #text-chat-section > * {
                display: block !important;
                width: 100%;
            }
            
            .section-title {
                display: block;
                margin-bottom: 10px;
            }
            
            #messages {
                font-size: 1rem;
                min-height: 150px;
                max-height: 400px;
                overflow-y: auto;
                margin-bottom: 10px;
            }
            
            #text-messages {
                font-size: 0.9rem;
                min-height: 150px;
                max-height: 300px;
                overflow-y: auto;
                margin-bottom: 10px;
            }
            
            #decoder-preview {
                height: 25px;
                font-size: 1.1rem;
                margin-bottom: 10px;
            }
            
            #morse-pad {
                height: 140px;
                margin-bottom: 10px;
            }
            
            #key {
                width: 90px;
                height: 90px;
            }
            
            header {
                padding: 8px;
                font-size: 0.85rem;
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            button {
                padding: 10px 14px;
                font-size: 0.9rem;
                display: block;
                width: 100%;
                margin-bottom: 8px;
            }
            
            .section-title {
                font-size: 0.9rem;
                padding: 10px;
            }
            
            .text-msg {
                margin-bottom: 12px;
                padding: 10px;
            }
            
            .text-msg .author {
                font-size: 0.9rem;
                margin-bottom: 5px;
            }
            
            .text-msg .content {
                font-size: 1rem;
            }
            
            #text-input {
                font-size: 16px;
                height: 45px;
                padding: 12px;
                display: block;
                width: 100%;
                margin-bottom: 10px;
            }
            
            #text-input-area {
                display: block;
                margin-bottom: 12px;
            }
            
            #text-send {
                padding: 12px 16px;
                font-size: 1rem;
                width: 100%;
                display: block;
                margin-bottom: 12px;
            }
            
            #morse-keyboard-toggle {
                padding: 12px;
                font-size: 0.9rem;
                width: 100%;
                display: block !important;
                margin-top: 12px;
                margin-bottom: 20px;
            }
        }
        
        @media (max-height: 600px) {
            #morse-pad {
                height: 100px;
            }
            
            #key {
                width: 70px;
                height: 70px;
            }
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <h2>üì° MORSE-LINK LIVE</h2>
    <div class="online-badge">üåç RADIO IN VETTA</div>
    <p style="color: #888; margin: 0; font-size: 0.9rem;">Real-time Global CW Chat + Text by IU2RPQ</p>
    <input type="text" id="callsign" class="input-box" placeholder="TUO NOMINATIVO (es. IU2RPQ)" maxlength="10" style="max-width: 300px;">
    <button onclick="startApp()">‚ñ∂ CONNETTI</button>
</div>

<header>
    <div class="header-left">
        <div><strong>STAZIONE:</strong> <span id="my-id">---</span></div>
        <div id="status-indicator" style="color: var(--green); font-size: 0.85rem;">‚óè ONLINE</div>
    </div>
    <div class="header-buttons">
        <button id="audio-activate-btn" class="btn-green" onclick="activateAudioManually()">üîä ATTIVA AUDIO</button>
        <button onclick="mapExternalKey()" id="map-btn">‚å®Ô∏è MAPPA TASTO</button>
        <button onclick="openSettings()">‚öôÔ∏è SETTINGS</button>
    </div>
</header>

<div id="main">
    <div id="sidebar">
        <div style="font-size: 0.85rem; font-weight: bold; color: var(--green); border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px;">
            üåç ONLINE
        </div>
        <div id="user-list"></div>
    </div>
    
    <div id="morse-section">
        <div class="section-title" style="color: var(--amber); border-color: var(--amber);">
            üìª MORSE CODE
            <button onclick="toggleDecoder()" id="decoder-toggle-top" style="float: right; padding: 5px 10px; font-size: 0.7rem; background: var(--green); border-color: var(--green); color: #000;">
                üëÅÔ∏è DECODER: ON
            </button>
        </div>
        <div id="messages"></div>
        <div id="decoder-preview"></div>
        <div id="morse-pad">
            <div id="key"></div>
        </div>
    </div>
    
    <div id="text-chat-section">
        <div class="section-title" style="color: var(--blue); border-color: var(--blue);">
            üí¨ TEXT CHAT
        </div>
        <div id="text-messages"></div>
        <div id="text-input-area">
            <input type="text" id="text-input" placeholder="Scrivi messaggio..." maxlength="200">
            <button id="text-send" onclick="sendTextMessage()">INVIA</button>
        </div>
        <button id="morse-keyboard-toggle" onclick="toggleMorseKeyboard()" style="width: 100%; margin-top: 8px; padding: 8px; font-size: 0.85rem; background: var(--green); border-color: var(--green); color: #000; font-weight: bold;">
            ‚å®Ô∏è MORSE KEYBOARD: ON
        </button>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeSettings()">‚úï</button>
        <h2 style="color: var(--amber); margin-top: 0;">‚öôÔ∏è IMPOSTAZIONI</h2>
        
        <div class="setting-row">
            <div class="setting-label">Mostra/Nascondi Testo</div>
            <div class="toggle-switch active" id="toggle-text" onclick="toggleTextDisplay()">
                <div class="toggle-slider"></div>
            </div>
        </div>
        
        <div class="setting-row">
            <div class="setting-label">QRM Sottofondo</div>
            <div class="toggle-switch" id="toggle-qrm" onclick="toggleQRM()">
                <div class="toggle-slider"></div>
            </div>
        </div>
        
        <div class="setting-row">
            <div class="setting-label">üåê Lingua / Language</div>
            <select onchange="changeLanguage(this.value)" id="lang-selector" style="padding: 8px; background: #000; color: var(--amber); border: 1px solid var(--amber); font-family: 'Courier New', monospace;">
                <option value="it">üáÆüáπ Italiano</option>
                <option value="en">üá¨üáß English</option>
            </select>
        </div>
        
        <div class="setting-row">
            <div class="setting-label">üìß Contattaci</div>
            <button onclick="sendEmail()" style="padding: 8px 16px; background: var(--blue); border-color: var(--blue);">‚úâÔ∏è INVIA EMAIL</button>
        </div>
        
        <div class="setting-row">
            <div class="setting-label">üìö Manuale Utente</div>
            <button onclick="openManuale()" style="padding: 8px 16px; background: var(--green); border-color: var(--green); color: #000; font-weight: bold;">üìñ APRI GUIDA</button>
        </div>
        
        <div class="setting-row">
            <div class="setting-label">Pannello Admin</div>
            <button onclick="closeSettings(); showAdminLogin();" style="padding: 8px 16px;">üîê ACCEDI</button>
        </div>
        
        <div class="setting-row">
            <div class="setting-label">Pulisci Chat Morse</div>
            <button onclick="clearChat()" style="padding: 8px 16px; background: #f00; border-color: #f00; color: #fff;">üóëÔ∏è PULISCI</button>
        </div>
        
        <div class="setting-row">
            <div class="setting-label">Pulisci Chat Text</div>
            <button onclick="clearTextChat()" style="padding: 8px 16px; background: #f00; border-color: #f00; color: #fff;">üóëÔ∏è PULISCI</button>
        </div>
    </div>
</div>

<!-- Admin Login Modal -->
<div id="admin-modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeAdminModal()">‚úï</button>
        <h2 style="color: var(--amber); margin-top: 0;">üîê ACCESSO ADMIN</h2>
        <input type="password" id="admin-pwd" class="input-box" placeholder="Password" style="margin: 20px 0;">
        <div style="display: flex; gap: 10px;">
            <button onclick="checkAdminPassword()" style="flex: 1;">ACCEDI</button>
            <button onclick="closeAdminModal()" style="flex: 1; background: #333;">ANNULLA</button>
        </div>
        <p id="admin-error" style="color: #f00; margin-top: 10px; display: none;">Password errata!</p>
    </div>
</div>

<!-- Admin Panel -->
<div id="admin-panel">
    <div class="panel-content">
        <button class="close-btn" onclick="closeAdminPanel()">‚úï</button>
        <h2 style="color: var(--amber);">‚öôÔ∏è PANNELLO AMMINISTRAZIONE</h2>
        
        <h3 style="color: var(--green); margin-top: 30px;">üñºÔ∏è SFONDO PERSONALIZZATO</h3>
        <div class="upload-zone" onclick="document.getElementById('bg-upload').click()">
            <p>üìÅ Clicca per caricare immagine di sfondo</p>
            <p style="color: #666; font-size: 0.8rem;">JPG, PNG (max 5MB)</p>
        </div>
        <input type="file" id="bg-upload" accept="image/*" style="display: none;" onchange="handleBackgroundUpload(event)">
        
        <div id="bg-preview-container" style="display: none;">
            <img id="bg-preview" class="bg-preview">
            <button onclick="removeBackground()" style="background: #f00; border-color: #f00; color: #fff;">üóëÔ∏è RIMUOVI</button>
        </div>
        
        <h3 style="color: var(--green); margin-top: 30px;">üé® TRASPARENZA CHAT</h3>
        <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 10px;">
                Opacit√†: <span id="opacity-value">70</span>%
            </label>
            <input type="range" id="opacity-slider" min="0" max="100" value="70" oninput="updateChatOpacity(this.value)">
        </div>
        
        <button onclick="resetOpacity()" style="width: 100%; margin-top: 10px;">
            üîÑ RESET OPACIT√Ä
        </button>
        
        <h3 style="color: var(--green); margin-top: 30px;">üîä TEST AUDIO</h3>
        <button onclick="testAudioReception()" style="width: 100%; margin-top: 10px;">
            üéµ TEST SOS
        </button>
        <p id="audio-test-result" style="color: #666; font-size: 0.8rem; margin-top: 10px;"></p>
        
        <h3 style="color: var(--green); margin-top: 30px;">üìä STATISTICHE</h3>
        <div class="stat-box">
            <div class="stat-label">Messaggi Morse</div>
            <div class="stat-value" id="stat-morse">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Messaggi Text</div>
            <div class="stat-value" id="stat-text">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Utenti Unici</div>
            <div class="stat-value" id="stat-users">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Utenti Online</div>
            <div class="stat-value" id="stat-online">0</div>
        </div>
        <button onclick="resetStats()" style="background: #f00; border-color: #f00; color: #fff; margin-top: 20px; width: 100%;">
            üóëÔ∏è RESET STATISTICHE
        </button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA7XqQnQRc0NbxgewBADmpdieylU7eTNHE",
        authDomain: "morse-link-live.firebaseapp.com",
        databaseURL: "https://morse-link-live-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "morse-link-live",
        storageBucket: "morse-link-live.firebasestorage.app",
        messagingSenderId: "170315866392",
        appId: "1:170315866392:web:91918cc223656b2d40be6d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let callsign = "";
    let audioCtx, oscillator, gainNode, qrmInterval;
    let startTime = 0, isDown = false, morseBuffer = "";
    let mappedKey = null, isMapping = false;
    let lastUp = Date.now();
    let textDisplayEnabled = true;
    let decoderEnabled = true;
    let audioEnabled = false;
    let qrmEnabled = false;
    let morseKeyboardEnabled = true;
    
    const ADMIN_PASSWORD = "radio1010";
    const lastMsgUser = {};
    const DOT_DURATION = 100;
    const DASH_DURATION = 300;
    const SYMBOL_GAP = 100;
    const LETTER_GAP = 300;

    const MORSE = { 
        ".-": "A", "-...": "B", "-.-.": "C", "-..": "D", ".": "E", 
        "..-.": "F", "--.": "G", "....": "H", "..": "I", ".---": "J", 
        "-.-": "K", ".-..": "L", "--": "M", "-.": "N", "---": "O", 
        ".--.": "P", "--.-": "Q", ".-.": "R", "...": "S", "-": "T", 
        "..-": "U", "...-": "V", ".--": "W", "-..-": "X", "-.--": "Y", 
        "--..": "Z", "-----": "0", ".----": "1", "..---": "2", "...--": "3", 
        "....-": "4", ".....": "5", "-....": "6", "--...": "7", "---..": "8", 
        "----.": "9", "..--..": "?", "-..-.": "/", ".-.-.-": "."
    };

    const CHAR_TO_MORSE = Object.fromEntries(Object.entries(MORSE).map(([k, v]) => [v, k]));

    function scrollToBottom(container) {
        requestAnimationFrame(() => {
            container.scrollTop = container.scrollHeight;
        });
    }

    function initAudio() {
        if(!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if(audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        audioEnabled = true;
        console.log('üéµ Audio inizializzato, state:', audioCtx.state);
    }
    
    function playBeep(duration) {
        if(!audioCtx) return Promise.resolve();
        
        return new Promise((resolve) => {
            try {
                const osc = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                osc.frequency.value = 700;
                osc.type = 'sine';
                gainNode.gain.value = 0.15;  // Volume fisso
                
                osc.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + (duration / 1000));
                
                setTimeout(() => resolve(), duration);
            } catch(err) {
                console.error('‚ùå Beep error:', err);
                resolve();
            }
        });
    }
    
    async function playMorseChar(char) {
        if(!audioCtx) return;
        
        const morse = CHAR_TO_MORSE[char.toUpperCase()];
        if(!morse) return;
        
        for(let symbol of morse) {
            const duration = symbol === '.' ? DOT_DURATION : DASH_DURATION;
            await playBeep(duration);
            await new Promise(resolve => setTimeout(resolve, SYMBOL_GAP));
        }
    }
    
    function startQRM() {
        if(!audioCtx) {
            console.warn('‚ö†Ô∏è startQRM: audioCtx null, inizializzo...');
            initAudio();
        }
        
        if(qrmInterval) {
            console.log('‚ö†Ô∏è QRM gi√† attivo');
            return;
        }
        
        qrmInterval = setInterval(() => {
            if(!qrmEnabled) return;
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.frequency.value = 300 + Math.random() * 400;
            osc.type = 'sawtooth';
            gainNode.gain.value = 0.02 + Math.random() * 0.03;
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1 + Math.random() * 0.2);
        }, 200 + Math.random() * 300);
        
        console.log('üìª QRM ON');
    }
    
    function stopQRM() {
        if(qrmInterval) {
            clearInterval(qrmInterval);
            qrmInterval = null;
            console.log('üîá QRM OFF');
        }
    }
    
    function toggleQRM() {
        qrmEnabled = !qrmEnabled;
        const toggle = document.getElementById('toggle-qrm');
        
        if(qrmEnabled) {
            toggle.classList.add('active');
            if(audioEnabled) startQRM();
        } else {
            toggle.classList.remove('active');
            stopQRM();
        }
    }

    function sendMessage(char) {
        db.ref('chat').push({
            user: callsign,
            text: char,
            time: Date.now()
        });
    }
    
    function sendTextMessage() {
        const input = document.getElementById('text-input');
        const text = input.value.trim();
        
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üì§ SEND TEXT MESSAGE');
        console.log('Input value:', input.value);
        console.log('Trimmed text:', text);
        console.log('Callsign:', callsign);
        
        if(!text) {
            console.log('‚ö†Ô∏è Messaggio vuoto - ANNULLATO');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            return;
        }
        
        if(!callsign) {
            console.log('‚ùå Callsign non definito!');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            alert('Errore: non sei loggato!');
            return;
        }
        
        const messageData = {
            user: callsign,
            message: text,
            time: Date.now()
        };
        
        console.log('üì¶ Dati da inviare:', messageData);
        console.log('üì° Invio a Firebase...');
        
        db.ref('textChat').push(messageData)
            .then(() => {
                console.log('‚úÖ MESSAGGIO INVIATO A FIREBASE!');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            })
            .catch(err => {
                console.error('‚ùå ERRORE FIREBASE:', err);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                if(err.code === 'PERMISSION_DENIED') {
                    alert('‚ùå ERRORE PERMESSI FIREBASE!\n\nLa text chat non funziona perch√© mancano i permessi nel database.\n\nSoluzione:\n1. Vai su Firebase Console\n2. Realtime Database ‚Üí Rules\n3. Aggiungi permessi per "textChat"\n4. Pubblica le nuove regole\n\nDettagli tecnici: ' + err.message);
                } else {
                    alert('Errore invio: ' + err.message);
                }
            });
        
        input.value = '';
        input.focus();
    }

    async function addMsgToUI(user, text, shouldPlayAudio = false) {
        const box = document.getElementById('messages');
        const last = box.lastElementChild;
        
        if(last && last.dataset.user === user) {
            const strong = last.querySelector('strong');
            const currentContent = last.textContent || last.innerText;
            const contentAfterName = currentContent.substring(currentContent.indexOf(':') + 1).trim();
            
            last.innerHTML = '';
            last.appendChild(strong);
            last.appendChild(document.createTextNode(' ' + contentAfterName + text));
        } else {
            const div = document.createElement('div');
            div.className = 'msg';
            div.dataset.user = user;
            const userColor = user === callsign ? 'var(--amber)' : '#0af';
            
            const strong = document.createElement('strong');
            strong.style.color = userColor;
            strong.textContent = user + ':';
            
            div.appendChild(strong);
            div.appendChild(document.createTextNode(' ' + text));
            box.appendChild(div);
        }
        
        scrollToBottom(box);
        
        if(shouldPlayAudio) {
            console.log('üîä Riproduzione audio per messaggio remoto...');
            await playMorseChar(text);
        }
    }
    
    function addTextMsgToUI(user, message, time) {
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üì© ADD TEXT MSG TO UI');
        console.log('User:', user);
        console.log('Message:', message);
        console.log('Time:', time);
        
        const box = document.getElementById('text-messages');
        
        if(!box) {
            console.error('‚ùå text-messages element NON TROVATO!');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            return;
        }
        
        console.log('üì¶ Creazione elemento messaggio...');
        
        const div = document.createElement('div');
        div.className = 'text-msg';
        
        const author = document.createElement('div');
        author.className = 'author';
        
        // Colore diverso per messaggi SYSTEM
        if(user === 'SYSTEM') {
            author.style.color = '#888';
            div.style.borderLeftColor = '#666';
            div.style.background = 'rgba(100, 100, 100, 0.1)';
        } else {
            author.style.color = user === callsign ? 'var(--amber)' : 'var(--blue)';
        }
        
        author.textContent = user;
        
        const content = document.createElement('div');
        content.className = 'content';
        content.textContent = message;
        
        const timestamp = document.createElement('div');
        timestamp.className = 'time';
        timestamp.textContent = new Date(time).toLocaleTimeString('it-IT');
        
        div.appendChild(author);
        div.appendChild(content);
        div.appendChild(timestamp);
        
        box.appendChild(div);
        
        console.log('‚úÖ Messaggio aggiunto al DOM!');
        console.log('Total messages in box:', box.children.length);
        
        scrollToBottom(box);
        
        console.log('‚úÖ Scroll effettuato');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    }

    function toggleTextDisplay() {
        textDisplayEnabled = !textDisplayEnabled;
        const box = document.getElementById('messages');
        const toggle = document.getElementById('toggle-text');
        
        if(textDisplayEnabled) {
            box.classList.remove('hide-text');
            toggle.classList.add('active');
        } else {
            box.classList.add('hide-text');
            toggle.classList.remove('active');
        }
    }
    
    function toggleDecoder() {
        decoderEnabled = !decoderEnabled;
        const decoder = document.getElementById('decoder-preview');
        const toggleBtn = document.getElementById('decoder-toggle-top');
        
        if(decoderEnabled) {
            decoder.style.display = 'block';
            toggleBtn.innerHTML = 'üëÅÔ∏è DECODER: ON';
            toggleBtn.style.background = 'var(--green)';
            toggleBtn.style.borderColor = 'var(--green)';
        } else {
            decoder.style.display = 'none';
            toggleBtn.innerHTML = 'üëÅÔ∏è DECODER: OFF';
            toggleBtn.style.background = '#666';
            toggleBtn.style.borderColor = '#666';
        }
    }

    function clearChat() {
        if(confirm('Pulire Morse chat?')) {
            document.getElementById('messages').innerHTML = '';
            closeSettings();
        }
    }
    
    function clearTextChat() {
        if(confirm('Pulire Text chat?')) {
            document.getElementById('text-messages').innerHTML = '';
            closeSettings();
        }
    }
    
    function openSettings() {
        document.getElementById('settings-modal').classList.add('show');
    }
    
    function closeSettings() {
        document.getElementById('settings-modal').classList.remove('show');
    }
    
    function openManuale() {
        // Apri manuale in nuova tab
        window.open('https://morse.radioinvetta.it/manuale-utente.html', '_blank');
    }
    
    function sendEmail() {
        // Apri client email con indirizzo precompilato
        const subject = encodeURIComponent('MORSE-LINK Feedback da ' + (callsign || 'Utente'));
        const body = encodeURIComponent('Ciao,\n\nScrivo riguardo a MORSE-LINK LIVE.\n\n[Il tuo messaggio qui]\n\n---\nCallsign: ' + (callsign || 'N/A') + '\nBrowser: ' + navigator.userAgent);
        window.location.href = `mailto:info@radioinvetta.it?subject=${subject}&body=${body}`;
    }
    
    // Sistema lingua semplificato
    let currentLang = 'it';
    
    const translations = {
        it: {
            callsignPlaceholder: 'TUO NOMINATIVO (es. IU2RPQ)',
            connectBtn: '‚ñ∂ CONNETTI',
            station: 'STAZIONE:',
            online: '‚óè ONLINE',
            mapKeyBtn: 'MAPPA TASTO',
            textInputPlaceholder: 'Scrivi messaggio...',
            sendBtn: 'INVIA',
            enterCallsign: 'Inserisci nominativo!',
            callsignTooShort: 'Nominativo troppo corto!',
            clearMorseConfirm: 'Pulire Morse chat?',
            clearTextConfirm: 'Pulire Text chat?'
        },
        en: {
            callsignPlaceholder: 'YOUR CALLSIGN (e.g. W1AW)',
            connectBtn: '‚ñ∂ CONNECT',
            station: 'STATION:',
            online: '‚óè ONLINE',
            mapKeyBtn: 'MAP KEY',
            textInputPlaceholder: 'Type message...',
            sendBtn: 'SEND',
            enterCallsign: 'Enter callsign!',
            callsignTooShort: 'Callsign too short!',
            clearMorseConfirm: 'Clear Morse chat?',
            clearTextConfirm: 'Clear Text chat?'
        }
    };
    
    function changeLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('morse-lang', lang);
        
        // Aggiorna elementi chiave
        const t = translations[lang];
        
        // Login
        const callsignInput = document.getElementById('callsign');
        if(callsignInput) callsignInput.placeholder = t.callsignPlaceholder;
        
        // Text chat
        const textInput = document.getElementById('text-input');
        if(textInput) textInput.placeholder = t.textInputPlaceholder;
        
        const textSend = document.getElementById('text-send');
        if(textSend) textSend.innerText = t.sendBtn;
        
        // Aggiorna HTML lang attribute
        document.documentElement.lang = lang;
        
        console.log('üåê Lingua cambiata:', lang);
    }
    
    // Carica lingua salvata al caricamento
    window.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem('morse-lang');
        if(saved && translations[saved]) {
            currentLang = saved;
            const selector = document.getElementById('lang-selector');
            if(selector) selector.value = saved;
            changeLanguage(saved);
        }
    });

    function startApp() {
        callsign = document.getElementById('callsign').value.trim().toUpperCase();
        
        const t = translations[currentLang];
        
        if(!callsign) {
            alert(t.enterCallsign);
            return;
        }
        
        if(callsign.length < 3) {
            alert(t.callsignTooShort);
            return;
        }
        
        document.getElementById('my-id').innerText = callsign;
        document.getElementById('login-overlay').style.display = 'none';
        
        initAudio();
        
        // CHROME: Mostra avviso OBBLIGATORIO per attivare audio
        const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
        if(isChrome && audioCtx && audioCtx.state === 'suspended') {
            setTimeout(() => {
                alert('‚ö†Ô∏è IMPORTANTE!\n\nSu Chrome devi cliccare il pulsante\nüîä ATTIVA AUDIO\nin alto per sentire i messaggi Morse in arrivo.');
            }, 500);
        }
        
        // CHROME FIX: Attiva audio al primo click/touch
        document.body.addEventListener('touchstart', () => {
            if(audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    console.log('‚úÖ Audio resumed on touch');
                });
            }
        }, { once: true });
        
        document.body.addEventListener('click', () => {
            if(audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    console.log('‚úÖ Audio resumed on click');
                });
            }
        }, { once: true });

        const userRef = db.ref('users/' + callsign);
        userRef.set({ status: "online", lastSeen: Date.now() });
        userRef.onDisconnect().remove();

        db.ref('users').on('value', snap => {
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            snap.forEach(child => {
                const isSelf = child.key === callsign;
                const color = isSelf ? 'var(--amber)' : 'var(--green)';
                const suffix = isSelf ? ' (TU)' : '';
                list.innerHTML += `<span class="user-tag" style="color: ${color};">‚Ä¢ ${child.key}${suffix}</span>`;
            });
        });

        let initialLoad = true;
        db.ref('chat').limitToLast(50).once('value', () => { initialLoad = false; });
        
        db.ref('chat').limitToLast(50).on('child_added', snap => {
            const data = snap.val();
            if(data && data.user && data.text) {
                const isNewMessage = !lastMsgUser[data.user] || lastMsgUser[data.user] !== snap.key;
                if(isNewMessage) {
                    const isRemote = data.user !== callsign;
                    const shouldPlayAudio = !initialLoad && isRemote;
                    addMsgToUI(data.user, data.text, shouldPlayAudio);
                    lastMsgUser[data.user] = snap.key;
                }
            }
        });
        
        console.log('üî• Inizializzazione listener TEXT CHAT Firebase...');
        
        db.ref('textChat').limitToLast(50).on('child_added', snap => {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üî• FIREBASE: child_added event (textChat)');
            console.log('Snapshot key:', snap.key);
            
            const data = snap.val();
            console.log('Raw data:', data);
            
            if(!data) {
                console.log('‚ö†Ô∏è Data √® null/undefined');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                return;
            }
            
            if(!data.user) {
                console.log('‚ö†Ô∏è data.user mancante:', data);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                return;
            }
            
            if(!data.message) {
                console.log('‚ö†Ô∏è data.message mancante:', data);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                return;
            }
            
            console.log('‚úÖ Dati validi, chiamata addTextMsgToUI...');
            addTextMsgToUI(data.user, data.message, data.time);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        });

        db.ref('admin/background').once('value').then(snap => {
            const bgData = snap.val();
            if(bgData) applyBackground(bgData);
        });
        
        db.ref('admin/chatOpacity').once('value').then(snap => {
            const opacity = snap.val();
            if(opacity !== null) applyChatOpacity(opacity);
        });

        console.log('‚úÖ Connesso:', callsign);
        
        // Debug layout mobile
        const isMobile = window.innerWidth <= 768;
        console.log('üì± Mobile device:', isMobile);
        console.log('üìê Window size:', window.innerWidth, 'x', window.innerHeight);
        
        if(isMobile) {
            setTimeout(() => {
                const textChatSection = document.getElementById('text-chat-section');
                if(textChatSection) {
                    const style = getComputedStyle(textChatSection);
                    console.log('üí¨ Text chat section:');
                    console.log('  - Display:', style.display);
                    console.log('  - Visibility:', style.visibility);
                    console.log('  - Height:', textChatSection.offsetHeight + 'px');
                    console.log('  - Top:', textChatSection.getBoundingClientRect().top);
                } else {
                    console.error('‚ùå text-chat-section NOT FOUND!');
                }
            }, 500);
        }
        
        // CHROME AUDIO FIX: Verifica se AudioContext √® suspended
        setTimeout(() => {
            if(audioCtx && audioCtx.state === 'suspended') {
                console.warn('‚ö†Ô∏è CHROME: AudioContext suspended!');
                console.warn('   Soluzione: Clicca "ATTIVA AUDIO" o premi il tasto Morse');
                
                // Mostra avviso se Chrome
                const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
                if(isChrome) {
                    console.log('üîç Browser: Chrome rilevato');
                    console.log('   Chrome richiede interazione utente per audio');
                }
            }
        }, 1000);
        
        // Test permessi Firebase per textChat
        testFirebasePermissions();
        
        // Messaggio di benvenuto nella text chat
        setTimeout(() => {
            addTextMsgToUI('SYSTEM', 'Benvenuto ' + callsign + '! Text chat attiva.', Date.now());
        }, 1000);
    }
    
    function testFirebasePermissions() {
        console.log('üîç Test permessi Firebase textChat...');
        
        db.ref('textChat').limitToLast(1).once('value')
            .then(() => {
                console.log('‚úÖ Permessi LETTURA: OK');
            })
            .catch(err => {
                console.error('‚ùå Permessi LETTURA: FALLITO', err);
                if(err.code === 'PERMISSION_DENIED') {
                    setTimeout(() => {
                        alert('‚ö†Ô∏è ATTENZIONE: Text chat non configurata!\n\nPermessi Firebase mancanti.\nLeggi il file FIREBASE-RULES-SETUP.md per la configurazione.');
                    }, 2000);
                }
            });
    }

    function play() {
        if(!audioCtx) {
            initAudio();
        }
        
        if(audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        
        oscillator = audioCtx.createOscillator();
        gainNode = audioCtx.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.value = 700;
        gainNode.gain.value = 0.15;  // Volume fisso semplice
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        
        console.log('üîä Beep trasmissione');
    }

    function stop() { 
        if(oscillator) {
            oscillator.stop(); 
            oscillator = null;
        }
    }

    function down(e) {
        if(isMapping) {
            mappedKey = (e.type === 'keydown') ? e.code : 'MOUSE';
            isMapping = false;
            document.getElementById('map-btn').innerText = "‚úì " + mappedKey;
            return;
        }
        
        // FILTRO EVENTI TASTIERA
        if(e.type === 'keydown') {
            const target = e.target;
            const tagName = target.tagName.toLowerCase();
            
            // Ignora se siamo in input o textarea
            if(tagName === 'input' || tagName === 'textarea') {
                return;
            }
            
            // Ignora se siamo su button e premi SPAZIO/INVIO
            if(tagName === 'button' && (e.code === 'Space' || e.code === 'Enter')) {
                return;
            }
            
            // Ignora se keyboard Morse √® disabilitato
            if(!morseKeyboardEnabled) {
                return;
            }
        }
        
        if(mappedKey && e.type === 'keydown' && e.code !== mappedKey) return;
        if(isDown) return;
        
        isDown = true;
        startTime = Date.now();
        play();  // NO await
    }

    function up(e) {
        // Se keyboard Morse √® disabilitata E l'evento viene da tastiera, ignora
        if(e && e.type === 'keyup' && !morseKeyboardEnabled) {
            return;
        }
        
        if(!isDown) return;
        isDown = false;
        stop();
        
        const dur = Date.now() - startTime;
        morseBuffer += (dur < 200) ? "." : "-";
        document.getElementById('decoder-preview').innerText = morseBuffer;
        lastUp = Date.now();
    }

    function mapExternalKey() {
        isMapping = true;
        document.getElementById('map-btn').innerText = "‚è≥ PREMI...";
    }
    
    function toggleMorseKeyboard() {
        morseKeyboardEnabled = !morseKeyboardEnabled;
        const btn = document.getElementById('morse-keyboard-toggle');
        const decoder = document.getElementById('decoder-preview');
        
        if(morseKeyboardEnabled) {
            btn.style.background = 'var(--green)';
            btn.style.borderColor = 'var(--green)';
            btn.style.color = '#000';
            btn.innerHTML = '‚å®Ô∏è MORSE KEYBOARD: ON';
            decoder.style.color = 'var(--green)';
            decoder.innerText = '';
            morseBuffer = ''; // Pulisci buffer
        } else {
            btn.style.background = '#666';
            btn.style.borderColor = '#666';
            btn.style.color = '#aaa';
            btn.innerHTML = '‚å®Ô∏è MORSE KEYBOARD: OFF';
            decoder.style.color = '#666';
            decoder.innerText = '‚å®Ô∏è KEYBOARD OFF';
        }
        
        console.log('‚å®Ô∏è Morse Keyboard:', morseKeyboardEnabled ? 'ON' : 'OFF');
    }

    setInterval(() => {
        if(morseBuffer !== "" && (Date.now() - lastUp > 600)) {
            const char = MORSE[morseBuffer] || "?";
            // IMPORTANTE: Invia SEMPRE il pattern morse, non il "?"
            // Cos√¨ il suono arriva comunque agli altri utenti
            const toSend = MORSE[morseBuffer] ? char : morseBuffer;
            sendMessage(toSend);
            morseBuffer = "";
            document.getElementById('decoder-preview').innerText = "";
        }
        
        // PUNTO 3: Aggiungi spazio nel decoder dopo pausa lunga
        if(morseBuffer === "" && (Date.now() - lastUp > 1200) && (Date.now() - lastUp < 1300)) {
            // Aggiungi spazio visivo nel decoder dopo pausa tra parole
            const decoder = document.getElementById('decoder-preview');
            if(decoder.innerText && !decoder.innerText.endsWith(' ')) {
                decoder.innerText += ' ';
            }
        }
    }, 100);

    async function activateAudioManually() {
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üîä ATTIVAZIONE AUDIO MANUALE');
        
        try {
            console.log('1. Inizializzazione audio...');
            initAudio();
            
            console.log('2. AudioContext state:', audioCtx ? audioCtx.state : 'null');
            
            if(audioCtx && audioCtx.state === 'suspended') {
                console.log('3. Resume AudioContext...');
                await audioCtx.resume();
                console.log('4. Stato dopo resume:', audioCtx.state);
            }
            
            console.log('5. Test beep 100ms...');
            await playBeep(100);
            console.log('6. Test beep OK!');
            
            const btn = document.getElementById('audio-activate-btn');
            if(btn) {
                btn.classList.add('activated');
                btn.innerHTML = '‚úÖ AUDIO ATTIVO';
                btn.style.background = '#666';
                btn.style.borderColor = '#666';
                btn.style.color = '#aaa';
            }
            
            if(qrmEnabled) startQRM();
            
            console.log('‚úÖ AUDIO COMPLETAMENTE ATTIVATO');
            console.log('   audioCtx.state:', audioCtx.state);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            alert('‚úÖ Audio attivato con successo!\n\nOra puoi sentire i messaggi Morse in arrivo.');
            
        } catch(err) {
            console.error('‚ùå ERRORE ATTIVAZIONE:', err);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            alert('‚ùå Errore attivazione audio:\n' + err.message + '\n\nProva a ricaricare la pagina.');
        }
    }

    function showAdminLogin() {
        document.getElementById('admin-modal').classList.add('show');
        document.getElementById('admin-pwd').value = '';
        document.getElementById('admin-error').style.display = 'none';
    }
    
    function closeAdminModal() {
        document.getElementById('admin-modal').classList.remove('show');
    }
    
    function checkAdminPassword() {
        const pwd = document.getElementById('admin-pwd').value;
        if(pwd === ADMIN_PASSWORD) {
            closeAdminModal();
            openAdminPanel();
        } else {
            document.getElementById('admin-error').style.display = 'block';
        }
    }
    
    function openAdminPanel() {
        document.getElementById('admin-panel').classList.add('show');
        loadAdminData();
    }
    
    function closeAdminPanel() {
        document.getElementById('admin-panel').classList.remove('show');
    }
    
    function loadAdminData() {
        db.ref('admin/background').once('value').then(snap => {
            const bgData = snap.val();
            if(bgData) {
                document.getElementById('bg-preview').src = bgData;
                document.getElementById('bg-preview-container').style.display = 'block';
            }
        });
        
        db.ref('admin/chatOpacity').once('value').then(snap => {
            const opacity = snap.val() || 70;
            document.getElementById('opacity-slider').value = opacity;
            document.getElementById('opacity-value').innerText = opacity;
            applyChatOpacity(opacity);
        });
        
        updateStatistics();
    }
    
    function handleBackgroundUpload(event) {
        const file = event.target.files[0];
        if(!file) return;
        
        if(file.size > 5 * 1024 * 1024) {
            alert('File troppo grande!');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                let width = img.width, height = img.height;
                const maxWidth = 1920, maxHeight = 1080;
                
                if(width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width *= ratio;
                    height *= ratio;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                const optimizedData = canvas.toDataURL('image/jpeg', 0.7);
                db.ref('admin/background').set(optimizedData);
                
                document.getElementById('bg-preview').src = optimizedData;
                document.getElementById('bg-preview-container').style.display = 'block';
                applyBackground(optimizedData);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    function applyBackground(dataUrl) {
        document.body.style.backgroundImage = `url(${dataUrl})`;
        document.body.classList.add('has-background');
    }
    
    function removeBackground() {
        if(confirm('Rimuovere sfondo?')) {
            db.ref('admin/background').remove();
            document.body.style.backgroundImage = 'none';
            document.body.classList.remove('has-background');
            document.getElementById('bg-preview-container').style.display = 'none';
        }
    }
    
    function updateChatOpacity(value) {
        document.getElementById('opacity-value').innerText = value;
        applyChatOpacity(value);
        db.ref('admin/chatOpacity').set(parseInt(value));
    }
    
    function applyChatOpacity(value) {
        const opacity = value / 100;
        document.getElementById('messages').style.backgroundColor = `rgba(0, 0, 0, ${opacity})`;
        document.getElementById('text-messages').style.backgroundColor = `rgba(0, 0, 0, ${opacity * 0.9})`;
    }
    
    function resetOpacity() {
        updateChatOpacity(70);
        document.getElementById('opacity-slider').value = 70;
    }
    
    async function testAudioReception() {
        const resultEl = document.getElementById('audio-test-result');
        
        try {
            initAudio();
            if(audioCtx.state === 'suspended') await audioCtx.resume();
            
            resultEl.innerText = 'üéµ SOS...';
            resultEl.style.color = 'var(--amber)';
            
            await playMorseChar('S');
            await new Promise(r => setTimeout(r, LETTER_GAP));
            await playMorseChar('O');
            await new Promise(r => setTimeout(r, LETTER_GAP));
            await playMorseChar('S');
            
            resultEl.innerText = '‚úÖ OK!';
            resultEl.style.color = 'var(--green)';
        } catch(err) {
            resultEl.innerText = '‚ùå Errore';
            resultEl.style.color = '#f00';
        }
    }
    
    function updateStatistics() {
        db.ref('chat').once('value').then(snap => {
            document.getElementById('stat-morse').innerText = snap.numChildren();
        });
        
        db.ref('textChat').once('value').then(snap => {
            document.getElementById('stat-text').innerText = snap.numChildren();
            
            const messages = [];
            snap.forEach(child => messages.push(child.val()));
            const uniqueUsers = [...new Set(messages.map(m => m.user))];
            document.getElementById('stat-users').innerText = uniqueUsers.length;
        });
        
        db.ref('users').once('value').then(snap => {
            document.getElementById('stat-online').innerText = snap.numChildren();
        });
    }
    
    function resetStats() {
        if(confirm('RESET?')) {
            updateStatistics();
        }
    }

    const keyEl = document.getElementById('key');
    keyEl.addEventListener('mousedown', down);
    window.addEventListener('mouseup', (e) => up(e));
    keyEl.addEventListener('touchstart', (e) => { 
        e.preventDefault(); 
        e.stopPropagation();
        down(e); 
    }, { passive: false });
    window.addEventListener('touchend', (e) => {
        if(isDown) up(e);
    }, { passive: false });
    window.addEventListener('keydown', (e) => { 
        if(!e.repeat) {
            // Previeni scroll con Space
            if(e.code === 'Space' && e.code === mappedKey) {
                e.preventDefault();
            }
            down(e);
        }
    });
    window.addEventListener('keyup', (e) => up(e));

    document.body.addEventListener('touchmove', (e) => {
        if(e.target.id === 'key' || e.target.closest('#morse-pad')) {
            e.preventDefault();
        }
    }, { passive: false });
    
    // Event listener per chat text input
    document.addEventListener('DOMContentLoaded', () => {
        const textInput = document.getElementById('text-input');
        if(textInput) {
            textInput.addEventListener('keypress', (e) => {
                if(e.key === 'Enter') {
                    e.preventDefault();
                    sendTextMessage();
                }
            });
            
            // Disabilita Morse keyboard quando focus su input text
            textInput.addEventListener('focus', () => {
                if(morseKeyboardEnabled) {
                    const wasMorseOn = morseKeyboardEnabled;
                    toggleMorseKeyboard();
                    textInput.dataset.wasMorseOn = wasMorseOn;
                    console.log('üí¨ Focus su text input ‚Üí Morse Keyboard OFF');
                }
            });
            
            // Riabilita Morse keyboard quando perdi focus (opzionale)
            textInput.addEventListener('blur', () => {
                // Non riabilitare automaticamente, l'utente usa il toggle
                console.log('üí¨ Blur da text input');
            });
        }
    });

    console.log('üîß MORSE-LINK LIVE + TEXT CHAT');

</script>
</body>
</html>