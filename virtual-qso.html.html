<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIRTUAL QSO - Radio in Vetta</title>
    <style>
        :root {
            --amber: #ffb000;
            --green: #00ff00;
            --bg-black: #0a0a0a;
            --panel: #1e1e1e;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: var(--bg-black);
            color: var(--amber);
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }
        
        #header {
            background: var(--panel);
            padding: 15px;
            border-bottom: 2px solid var(--amber);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #vqso-container {
            display: grid;
            grid-template-columns: 250px 1fr 250px;
            height: calc(100vh - 60px);
            gap: 0;
        }
        
        .panel {
            background: var(--panel);
            border-right: 1px solid #333;
            padding: 15px;
            overflow-y: auto;
        }
        
        .panel:last-child {
            border-right: none;
        }
        
        #center-panel {
            background: #000;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        #setup-screen, #qso-screen {
            display: none;
        }
        
        #setup-screen.active, #qso-screen.active {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .level-btn, .mode-btn {
            background: #111;
            color: var(--amber);
            border: 2px solid #333;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            font-family: inherit;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .level-btn:hover, .mode-btn:hover {
            border-color: var(--amber);
            background: #222;
        }
        
        .level-btn.selected, .mode-btn.selected {
            border-color: var(--green);
            background: #1a3a1a;
            color: var(--green);
        }
        
        #start-qso-btn {
            background: linear-gradient(135deg, var(--amber), var(--green));
            color: #000;
            border: none;
            padding: 20px;
            margin-top: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        #start-qso-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        #messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #0a0a0a;
            border: 1px solid #333;
            margin-bottom: 15px;
        }
        
        .qso-msg {
            margin: 10px 0;
            padding: 10px;
            border-left: 3px solid var(--amber);
        }
        
        .qso-msg.bot {
            border-left-color: var(--green);
        }
        
        .qso-msg .callsign {
            color: var(--green);
            font-weight: bold;
        }
        
        .qso-msg .text {
            color: var(--amber);
            margin-top: 5px;
        }
        
        #input-area {
            display: flex;
            gap: 10px;
        }
        
        #vqso-input {
            flex: 1;
            background: #000;
            border: 1px solid var(--amber);
            color: var(--amber);
            padding: 15px;
            font-family: inherit;
            font-size: 1em;
        }
        
        #send-btn {
            background: var(--amber);
            color: #000;
            border: none;
            padding: 15px 30px;
            cursor: pointer;
            font-weight: bold;
        }
        
        #send-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .info-section {
            margin-bottom: 20px;
        }
        
        .info-section h3 {
            color: var(--green);
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        .info-section p {
            color: #888;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            #vqso-container {
                grid-template-columns: 1fr;
            }
            .panel { display: none; }
        }
    </style>
</head>
<body>

<div id="header">
    <div>üìª VIRTUAL QSO: <span id="status">STANDBY</span></div>
    <button onclick="window.location.href='index.html'" style="background:#333; color:var(--amber); border:none; padding:10px 20px; cursor:pointer;">‚Üê Torna a MORSE-LINK</button>
</div>

<div id="vqso-container">
    <!-- LEFT PANEL: Configuration -->
    <div class="panel">
        <h3>‚öôÔ∏è CONFIGURAZIONE</h3>
        <div id="config-display">
            <p><strong>Livello:</strong> <span id="level-display">-</span></p>
            <p><strong>Modalit√†:</strong> <span id="mode-display">-</span></p>
            <p><strong>Bot:</strong> <span id="bot-display">-</span></p>
            <p><strong>Il tuo call:</strong> <span id="user-call-display">-</span></p>
        </div>
    </div>
    
    <!-- CENTER PANEL: Main Area -->
    <div id="center-panel">
        <!-- Setup Screen -->
        <div id="setup-screen" class="active">
            <h2 style="color: var(--green); margin-bottom: 20px;">CONFIGURA IL TUO QSO VIRTUALE</h2>
            
            <h3 style="margin-top: 20px;">Scegli il livello:</h3>
            <button class="level-btn" data-level="beginner">‚óã PRINCIPIANTE</button>
            <button class="level-btn" data-level="intermediate">‚óã INTERMEDIO</button>
            <button class="level-btn" data-level="expert">‚óã ESPERTO</button>
            
            <h3 style="margin-top: 30px;">Scegli la modalit√†:</h3>
            <button class="mode-btn" data-mode="ragchew">Ragchew (conversazione amichevole)</button>
            <button class="mode-btn" data-mode="contest">Contest (rapido e codificato)</button>
            <button class="mode-btn" data-mode="dx">DX (collegamenti lontani)</button>
            <button class="mode-btn" data-mode="sota">SOTA (Summits On The Air)</button>
            <button class="mode-btn" data-mode="emergency">Emergency (comunicazioni di emergenza)</button>
            
            <button id="start-qso-btn" disabled>üöÄ INIZIA QSO</button>
        </div>
        
        <!-- QSO Screen -->
        <div id="qso-screen">
            <div id="messages-area"></div>
            <div id="input-area">
                <input type="text" id="vqso-input" placeholder="Scrivi il tuo messaggio in Morse code abbreviato...">
                <button id="send-btn">TRASMETTI</button>
            </div>
        </div>
    </div>
    
    <!-- RIGHT PANEL: Info -->
    <div class="panel">
        <h3>üí¨ INFO QSO</h3>
        
        <div class="info-section">
            <h3>Come funziona</h3>
            <p>1. Scegli livello e modalit√†<br>
               2. Inizia il QSO<br>
               3. Il bot chiamer√† CQ<br>
               4. Rispondi usando le abbreviazioni morse standard</p>
        </div>
        
        <div class="info-section">
            <h3>Abbreviazioni comuni</h3>
            <p>CQ = chiamata generale<br>
               DE = "da" (precede il tuo call)<br>
               K = "passo a te"<br>
               UR = "your" (tuo/a)<br>
               TNX = "thanks"<br>
               73 = "saluti"<br>
               SK = "fine comunicazione"</p>
        </div>
        
        <div class="info-section">
            <h3>Esempio QSO</h3>
            <p style="color: var(--green);">Bot: CQ CQ IW3XDP<br>
               <span style="color: var(--amber);">Tu: IW3XDP DE IU2RPQ IU2RPQ K</span><br>
               <span style="color: var(--green);">Bot: IU2RPQ DE IW3XDP TNX CALL UR RST 599...</span></p>
        </div>
    </div>
</div>

<script>
// =============================================
// VIRTUAL QSO - CONFIGURAZIONE
// =============================================
const vqsoConfig = {
    level: null,
    mode: null,
    botCallsign: null,
    userCallsign: null,
    history: [],
    qsoActive: false
};

// Genera callsign casuale per il bot
function generateBotCallsign() {
    const prefixes = ['IW', 'IZ', 'IK', 'I'];
    const numbers = ['0', '1', '2', '3', '4', '5'];
    const suffixes = ['AAA', 'BBB', 'CCC', 'DDD', 'XYZ', 'QRP', 'DX', 'VHF'];
    
    const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
    const number = numbers[Math.floor(Math.random() * numbers.length)];
    const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
    
    return prefix + number + suffix;
}

// =============================================
// ESTRAZIONE CALLSIGN DOPO "DE" - VERSIONE ROBUSTA
// =============================================
function extractCallsignAfterDE(message) {
    // Converti in maiuscolo e normalizza
    let msg = message.toUpperCase().trim();
    
    // Rimuovi spazi multipli
    msg = msg.replace(/\s+/g, ' ');
    
    // STRATEGIA 1: DE con spazi (corretto)
    // Esempio: "IW3XDP DE IU2RPQ K"
    let dePattern = /\bDE\s+([A-Z]{1,2}[0-9][A-Z]{2,4})\b/;
    let match = msg.match(dePattern);
    if (match && match[1]) {
        console.log('‚úì Callsign trovato dopo DE (spazio):', match[1]);
        return match[1];
    }
    
    // STRATEGIA 2: DE attaccato al callsign seguente
    // Esempio: "IW3XDPDEIU2RPQ" o "IW3XDP DEIU2RPQ"
    dePattern = /DE([A-Z]{1,2}[0-9][A-Z]{2,4})\b/;
    match = msg.match(dePattern);
    if (match && match[1]) {
        console.log('‚úì Callsign trovato dopo DE (attaccato):', match[1]);
        return match[1];
    }
    
    // STRATEGIA 3: DE con errori di battitura (d e, dee, dde, etc)
    // Cerca varianti comuni: D E, DEE, DDE, ED, etc.
    const deVariants = /\b(D\s*E|DEE|DDE|ED)\s*([A-Z]{1,2}[0-9][A-Z]{2,4})\b/;
    match = msg.match(deVariants);
    if (match && match[2]) {
        console.log('‚úì Callsign trovato dopo DE (variante):', match[2]);
        return match[2];
    }
    
    // STRATEGIA 4: Cerca il secondo callsign nel messaggio
    // Logica: primo callsign = destinatario, secondo = mittente
    // Esempio: "IW3XDP IU2RPQ K" ‚Üí prende IU2RPQ
    const allCallsigns = msg.match(/\b([A-Z]{1,2}[0-9][A-Z]{2,4})\b/g);
    if (allCallsigns && allCallsigns.length >= 2) {
        // Verifica che il secondo sia diverso dal primo
        if (allCallsigns[1] !== allCallsigns[0]) {
            console.log('‚úì Callsign trovato come secondo nel messaggio:', allCallsigns[1]);
            return allCallsigns[1];
        }
    }
    
    // STRATEGIA 5: Se c'√® un solo callsign, probabilmente √® quello dell'utente
    // (caso in cui il bot sia gi√† noto)
    if (allCallsigns && allCallsigns.length === 1) {
        console.log('‚úì Callsign trovato (unico nel messaggio):', allCallsigns[0]);
        return allCallsigns[0];
    }
    
    console.log('‚úó Nessun callsign identificato');
    return null;
}

// =============================================
// SETUP SCREEN
// =============================================
document.querySelectorAll('.level-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.level-btn').forEach(b => {
            b.classList.remove('selected');
            b.textContent = b.textContent.replace('‚óè', '‚óã');
        });
        btn.classList.add('selected');
        btn.textContent = btn.textContent.replace('‚óã', '‚óè');
        vqsoConfig.level = btn.dataset.level;
        checkCanStart();
    });
});

document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        vqsoConfig.mode = btn.dataset.mode;
        checkCanStart();
    });
});

function checkCanStart() {
    const startBtn = document.getElementById('start-qso-btn');
    if (vqsoConfig.level && vqsoConfig.mode) {
        startBtn.disabled = false;
    }
}

document.getElementById('start-qso-btn').addEventListener('click', startQSO);

function startQSO() {
    // Genera callsign bot
    vqsoConfig.botCallsign = generateBotCallsign();
    
    // Aggiorna display configurazione
    document.getElementById('level-display').textContent = vqsoConfig.level.toUpperCase();
    document.getElementById('mode-display').textContent = vqsoConfig.mode.toUpperCase();
    document.getElementById('bot-display').textContent = vqsoConfig.botCallsign;
    
    // Cambia schermata
    document.getElementById('setup-screen').classList.remove('active');
    document.getElementById('qso-screen').classList.add('active');
    document.getElementById('status').textContent = 'QSO ATTIVO';
    
    // Bot inizia con CQ
    setTimeout(() => {
        addMessage('bot', vqsoConfig.botCallsign, `CQ CQ CQ DE ${vqsoConfig.botCallsign} ${vqsoConfig.botCallsign} K`);
    }, 1000);
    
    vqsoConfig.qsoActive = true;
}

// =============================================
// MESSAGGI
// =============================================
function addMessage(type, callsign, text) {
    const messagesArea = document.getElementById('messages-area');
    const msgDiv = document.createElement('div');
    msgDiv.className = `qso-msg ${type}`;
    msgDiv.innerHTML = `
        <div class="callsign">${callsign}:</div>
        <div class="text">${text}</div>
    `;
    messagesArea.appendChild(msgDiv);
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

// =============================================
// INVIO MESSAGGIO UTENTE
// =============================================
document.getElementById('send-btn').addEventListener('click', sendMessage);
document.getElementById('vqso-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

function sendMessage() {
    const input = document.getElementById('vqso-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // NUOVA LOGICA: Estrai callsign dopo DE
    if (!vqsoConfig.userCallsign) {
        const extractedCall = extractCallsignAfterDE(message);
        if (extractedCall) {
            vqsoConfig.userCallsign = extractedCall;
            document.getElementById('user-call-display').textContent = extractedCall;
        }
    }
    
    // Mostra messaggio utente
    const displayCall = vqsoConfig.userCallsign || 'USER';
    addMessage('user', displayCall, message);
    
    // Salva nella history
    vqsoConfig.history.push({
        sender: 'user',
        message: message,
        callsign: vqsoConfig.userCallsign
    });
    
    input.value = '';
    
    // Simula risposta bot (versione DEMO - sostituisci con chiamata API)
    setTimeout(() => {
        generateBotResponse(message);
    }, 1500);
}

// =============================================
// RISPOSTA BOT (DEMO)
// =============================================
function generateBotResponse(userMessage) {
    const responses = {
        0: `${vqsoConfig.userCallsign || 'OM'} DE ${vqsoConfig.botCallsign} TNX FER CALL = UR RST 599 599 = NAME HR IS MARIO = QTH TORINO = HW CPY? K`,
        1: `FB ${vqsoConfig.userCallsign || 'OM'} = WX SUNNY HR = RIG ICOM IC7300 = ANT DIPOLE = UR WX? K`,
        2: `NICE QSO ${vqsoConfig.userCallsign || 'OM'} = TNX INFO = 73 ES CUL = ${vqsoConfig.botCallsign} SK`
    };
    
    const responseIndex = Math.min(vqsoConfig.history.length - 1, 2);
    const response = responses[responseIndex] || responses[2];
    
    addMessage('bot', vqsoConfig.botCallsign, response);
}

// =============================================
// INIT
// =============================================
console.log('Virtual QSO ready - versione con riconoscimento callsign dopo DE');
</script>

</body>
</html>
